<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸€å‘³æ·¨ç”Ÿæ´»å’–å•¡ç³»çµ±</title>
<style>
    /* å…¨å±€è®Šæ•¸èˆ‡é…è‰²å„ªåŒ– */
    :root {
        --color-primary: #5c3a21; /* ç¶“å…¸æ·±å’–å•¡ */
        --color-secondary: #9a6e4e; /* æº«æš–ä¸­å’–å•¡ */
        --color-accent: #e2b34a; /* é‡‘é»ƒè‰²/å¼·èª¿è‰² */
        --color-background: #fdf6e9; /* å¥¶æ²¹æ·ºé»ƒèƒŒæ™¯ */
        --color-light-gray: #e6e0d8; /* æŸ”å’Œé‚Šç•Œè‰² */
        --color-done-bg: #f5f0e7; /* å®Œæˆå“çš„èƒŒæ™¯è‰² */
        --color-success: #4a7d4a; /* å®Œæˆ/é€²åº¦ç¶  */
        --color-danger: #cf4a4a; /* å‰©é¤˜æ•¸ç´…è‰² */
        --color-total-progress: #d68910; /* ç¸½è¨ˆé€²åº¦æ©˜ */
        --color-section-bg: #ffffff; /* å€å¡ŠèƒŒæ™¯ */
        --color-text: #333333; /* ä¸»è¦æ–‡å­—è‰² */

        --shadow-subtle: 0 1px 4px rgba(0,0,0,0.08);
        --shadow-medium: 0 3px 8px rgba(0,0,0,0.1);
        --border-radius-lg: 12px;
        --border-radius-md: 8px;
    }

    /* åŸºç¤æ’ç‰ˆ */
    body { 
        font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", "Arial", sans-serif; 
        background: var(--color-background); 
        padding: 0 15px 30px 15px; 
        color: var(--color-text); 
        max-width: 960px; 
        margin: 0 auto;
        line-height: 1.6;
    }

    /* --- æ–°å¢ï¼šé ‚éƒ¨å°è¦½æŒ‰éˆ•ç¾åŒ– --- */
    .nav-header {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        justify-content: center;
    }
    .nav-btn {
        flex: 1;
        max-width: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        border: none;
        border-radius: var(--border-radius-md);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: var(--color-secondary);
        color: white;
        box-shadow: var(--shadow-subtle);
        text-decoration: none;
    }
    .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        filter: brightness(1.1);
    }
    .nav-btn:active { transform: translateY(0); }

    h2 { 
        text-align: center; 
        color: var(--color-primary); 
        margin: 25px 0 15px 0; 
        font-size: 28px; 
        font-weight: 700;
        letter-spacing: 1px;
    }
    
    /* è³‡è¨Šå€å¡Š */
    .info-section {
        background: var(--color-section-bg);
        padding: 15px;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-medium);
        margin-bottom: 20px;
        border-left: 5px solid var(--color-secondary);
    }
    .info-section h3 {
        color: var(--color-primary);
        font-size: 18px;
        margin: 0 0 10px 0;
        border-bottom: 2px dashed var(--color-light-gray);
        padding-bottom: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .info-section li { font-size: 14px; padding: 4px 0; color: #555; list-style: none; }
    .info-section li b { color: var(--color-danger); font-weight: 700; }
    
    #dynamicMemoList { display: flex; flex-wrap: wrap; gap: 15px; padding-top: 5px; list-style: none; padding-left: 0; }
    .dynamic-memo-title { width: 100%; margin-top: 10px; padding-bottom: 5px; color: var(--color-danger); font-weight: bold; border-top: 2px dashed var(--color-danger); }
    .dynamic-memo-item { color: var(--color-primary); font-weight: 600; white-space: nowrap; }
    .dynamic-memo-item .memo-tag { color: white; background-color: var(--color-total-progress); padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-size: 12px; }

    /* æ§åˆ¶å€ */
    .controls { 
        background: var(--color-section-bg); 
        padding: 15px; 
        border-radius: var(--border-radius-lg); 
        box-shadow: var(--shadow-subtle); 
        margin-bottom: 20px; 
        display: flex; 
        gap: 10px; 
        align-items: center;
    }
    select { 
        padding: 12px; 
        font-size: 16px; 
        border-radius: var(--border-radius-md); 
        border: 1px solid var(--color-light-gray); 
        flex-grow: 2;
        cursor: pointer;
        background-color: #fcfcfc;
    }
    .btn { 
        background: var(--color-accent); 
        color: var(--color-primary); 
        border: none; 
        padding: 12px 15px; 
        border-radius: var(--border-radius-md); 
        cursor: pointer; 
        font-weight: bold; 
        transition: all 0.2s;
        flex-grow: 1; 
    }
    .btn:hover { background: #f0c35f; transform: translateY(-1px); }
    #clearAllBtn { background: #aaaaaa; color: white; }

    /* çµ±è¨ˆå€ */
    .stats-container { display: flex; gap: 20px; margin-bottom: 20px; }
    .stat-box { flex: 1; background: var(--color-section-bg); border-radius: var(--border-radius-lg); padding: 15px; box-shadow: var(--shadow-medium); border-top: 6px solid var(--color-primary); }
    .stat-box h3 { margin: 0 0 10px 0; font-size: 16px; color: var(--color-primary); text-align: center; border-bottom: 1px solid var(--color-light-gray); padding-bottom: 8px; }
    .stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 15px; padding: 8px 10px; cursor: pointer; border-radius: 6px; font-weight: 500; }
    .stat-row:hover { background-color: var(--color-done-bg); }
    .stat-row.total { font-weight: 700; border-top: 2px solid var(--color-light-gray); margin-top: 15px; padding-top: 12px; color: var(--color-primary); }
    .stat-row-progress { height: 5px; background-color: var(--color-light-gray); border-radius: 2px; margin: 0 10px 8px 10px; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.3s ease; }
    .count-total { color: var(--color-danger); font-weight: bold; margin-right: 10px; }
    
    .stat-detail-list { margin-top: 8px; border-top: 1px dashed var(--color-light-gray); }
    .stat-detail-item { display: flex; align-items: center; font-size: 14px; padding: 8px 10px; border-bottom: 1px dotted #e0e0e0; cursor: pointer; border-radius: 4px; }
    .stat-detail-item.done { background-color: var(--color-done-bg); color: #888; text-decoration: line-through; }
    .customer-info { flex-grow: 1; }
    .customer-name { font-weight: 600; color: var(--color-primary); }
    .customer-tag { font-size: 11px; background-color: var(--color-accent); padding: 1px 4px; border-radius: 3px; margin-left: 8px; }

    /* Checkbox */
    .stat-detail-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; }
    .absence-toggle { font-size: 12px; padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; margin-right: 10px; cursor: pointer; }
    .stat-detail-item.absent { opacity: 0.5; background: #f9f9f9; }

    /* åƒ¹æ ¼å¡ç‰‡èˆ‡è¡¨æ ¼ */
    .price-card-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
    .price-card { background: #fff; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-medium); overflow: hidden; border: 1px solid var(--color-light-gray); }
    .price-card-header { background: var(--color-primary); color: #fff; padding: 10px; font-weight: bold; text-align: center; }
    .price-grid { display: grid; grid-template-columns: 1fr 1fr; padding: 10px; }
    .price-item { padding: 8px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; font-size: 14px; }
    .p-value { color: var(--color-danger); font-weight: bold; }
    .p-value::before { content: '$'; font-size: 12px; }

    .menu-group-full { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; border-radius: 8px; overflow: hidden; }
    .menu-group-full th { background-color: var(--color-secondary); color: white; padding: 12px 8px; font-size: 14px; }
    .menu-group-full td { padding: 10px 8px; text-align: center; font-size: 13px; border-bottom: 1px solid #eee; }
    .menu-price { color: var(--color-danger); font-weight: bold; }
    .menu-price::before { content: '$'; }

    /* RWD */
    @media (max-width: 768px) {
        .price-card-container, .stats-container, .price-grid { grid-template-columns: 1fr; flex-direction: column; }
        .controls { flex-wrap: wrap; }
        .btn { width: 48%; font-size: 14px; }
        .nav-btn { font-size: 15px; }
    }
</style>
</head>
<body>

<div class="nav-header">
    <a href="https://christypy.github.io/time" class="nav-btn"><span>â±ï¸</span> è¨ˆæ™‚å™¨</a>
    <a href="https://christypy.github.io/record" class="nav-btn"><span>ğŸ“</span> è¨˜éŒ„å™¨</a>
</div>

<h2>â˜• ä¸€å‘³æ·¨ç”Ÿæ´»å’–å•¡å‚™é¤åŠ©ç†</h2>

<div class="controls">
    <select id="daySelect" onchange="renderOrders()">
        <option value="1">æ˜ŸæœŸä¸€ (ä¼‘)</option>
        <option value="2">æ˜ŸæœŸäºŒ</option>
        <option value="3">æ˜ŸæœŸä¸‰</option>
        <option value="4">æ˜ŸæœŸå››</option>
        <option value="5">æ˜ŸæœŸäº”</option>
        <option value="6">æ˜ŸæœŸå…­</option>
        <option value="0">æ˜ŸæœŸæ—¥</option>
    </select>
    <button class="btn" onclick="renderOrders()">åˆ·æ–°åˆ—è¡¨</button>
    <button class="btn" id="clearAllBtn" onclick="clearAllDone()">å…¨éƒ¨é‡ç½®</button>
</div>

<div class="info-section">
    <h3>ğŸ“ å¸¸é§å‚™å¿˜</h3>
    <ul id="staticMemoList">
        <li><b>æé¾å«©ä»™è‰ï¼š</b>ç’°ä¿æ¯ç†±ç¾å¼</li>
        <li><b>å…§è¡£åº—è€é—†ï¼š</b>ç†±æ‹¿éµ</li>
        <li><b>èŠ­æ¨‚ï¼š</b>ç†±æ‹¿éµ + ç³–(3g)</li>
    </ul>
    <ul id="dynamicMemoList"></ul>
</div>

<div class="stats-container">
    <div class="stat-box" style="border-top-color: var(--color-success);">
        <h3>ğŸ  å·¦å³é„°å±… ç¸½è¨ˆ</h3>
        <div id="stats-neighbor"></div>
    </div>
    <div class="stat-box" style="border-top-color: var(--color-total-progress);">
        <h3>ğŸ›µ å…¶ä»–å€åŸŸ ç¸½è¨ˆ</h3>
        <div id="stats-other"></div>
    </div>
</div>

<div class="price-card-container">
    <div class="price-card">
        <div class="price-card-header">â˜• ç¾©å¼åŸºç¤é£²å“</div>
        <div class="price-grid">
            <div class="price-item"><span>ç†±ç¾å¼</span><span class="p-value">70</span></div>
            <div class="price-item"><span>ç†±æ‹¿éµ</span><span class="p-value">85</span></div>
            <div class="price-item"><span>å†°ç¾å¼</span><span class="p-value">75</span></div>
            <div class="price-item"><span>å†°æ‹¿éµ</span><span class="p-value">85</span></div>
            <div class="price-item"><span>å¤§ç†±ç¾</span><span class="p-value">80</span></div>
            <div class="price-item"><span>å¤§ç†±æ‹¿</span><span class="p-value">95</span></div>
            <div class="price-item"><span>ç†±ç‰›å¥¶</span><span class="p-value">50</span></div>
            <div class="price-item"><span>æŠ¹èŒ¶æ‹¿éµ</span><span class="p-value">85</span></div>
        </div>
    </div>
    <div class="price-card">
        <div class="price-card-header">å…¶ä»–å“é …</div>
        <div class="price-grid">
            <div class="price-item"><span>é…¸æŸ‘èŒ¶(å°)</span><span class="p-value">160</span></div>
            <div class="price-item"><span>å³æº¶(1æ¢)</span><span class="p-value">16</span></div>
            <div class="price-item"><span>é…¸æŸ‘èŒ¶(å¤§)</span><span class="p-value">950</span></div>
            <div class="price-item"><span>å³æº¶(30æ¢)</span><span class="p-value">475</span></div>
            <div class="price-item"><span>å°æ¿¾ç´™</span><span class="p-value">120</span></div>
            <div class="price-item"><span>å¤§æ¿¾ç´™</span><span class="p-value">130</span></div>
        </div>
    </div>
</div>

<div class="info-section">
    <h3>ğŸ“‹ å–®å“è±†å–®åƒè€ƒ</h3>
    <table class="menu-group-full">
        <thead>
            <tr><th>å“é …</th><th>å¤–å¸¶</th><th>å…§ç”¨</th><th>åŠç£…</th><th>æ¿¾æ›</th></tr>
        </thead>
        <tbody>
            <tr><td>è¦º</td><td>200</td><td>250</td><td>950</td><td>-</td></tr>
            <tr><td>èŠ±</td><td>180</td><td>230</td><td>850</td><td>55</td></tr>
            <tr><td>å¯¶</td><td>180</td><td>230</td><td>850</td><td>55</td></tr>
            <tr><td>è©</td><td>130</td><td>180</td><td>700</td><td>45</td></tr>
            <tr><td>é›…</td><td>130</td><td>180</td><td>650</td><td>45</td></tr>
        </tbody>
    </table>
</div>

<script>
    /* é€™è£¡ä¿ç•™æ‚¨åŸå§‹ç¢¼ä¸­æ‰€æœ‰çš„ Javascript é‚è¼¯ (customers æ•¸æ“šèˆ‡ render å‡½æ•¸) */
    const expandedStats = new Set();
    const customers = [
        { loc: "å³é‚Šé„°å±…", name: "æ€¡é¦™è»’", item: "ç†±ç¾å¼", type: "hot_am", days: [], count: 1, groupId: "neighbor_r_1" },
        { loc: "å³é‚Šé„°å±…", name: "æ²¹é£¯", item: "ç†±ç¾å¼", tag: "ç•¶æ—¥å•",type: "hot_am", days: [], count: 1, groupId: "neighbor_r_2"},
        { loc: "å³é‚Šé„°å±…", name: "å±±åŸç±³é£Ÿ", item: "ç†±æ‹¿éµ", type: "hot_latte", days: [], count: 1, note: "å¯„æ¯", groupId: "neighbor_r_3" }, 
        { loc: "å³é‚Šé„°å±…", name: "æ©˜å­æ”¤", item: "ç†±æ‹¿éµ", type: "hot_latte", days: [], count: 1, groupId: "neighbor_r_4" }, 
        { loc: "å³é‚Šé„°å±…", name: "ç³–æœ", item: "ç†±æ‹¿éµ", type: "hot_latte", days: [6, 0], count: 1, note: "ä»˜å…©å¤©", groupId: "neighbor_r_5" },
        { loc: "å·¦é‚Šé„°å±…", name: "ç‰›è‚‰", item: "ç†±æ‹¿éµ", type: "hot_latte_sugar", days: [3, 5, 0], count: 1, note: "åŠ 3gç³–", groupId: "neighbor_l_1" },
        { loc: "å·¦é‚Šé„°å±…", name: "å¸ƒè€é—†", item: "ç†±ç¾å¼", type: "hot_am", days: [5], count: 1, note: "å¯„æ¯", groupId: "neighbor_l_2" },
        { 
            loc: "å·¦é‚Šé„°å±…", 
            name: "ç”˜è”—é›", 
            item: [10, 11, 0, 1, 2].includes(new Date().getMonth()) ? "ç†±ç¾å¼" : "å†°ç¾å¼",
            type: [10, 11, 0, 1, 2].includes(new Date().getMonth()) ? "hot_am" : "ice_am",
            days: [], 
            count: 1, 
            groupId: "neighbor_l_3" 
        },
        { loc: "å·¦é‚Šé„°å±…", name: "åœ‹è¯å“¥", item: "å†°ç¾å¼", type: "ice_am", days: [], count: 1, groupId: "neighbor_l_4" },
        { loc: "å·¦é‚Šé„°å±…", name: "å®œè˜­é­šæ”¤", item: "å†°ç¾å¼", type: "ice_am", days: [6], count: 1, groupId: "neighbor_l_5" },
        { loc: "å·¦é‚Šé„°å±…", name: "å®œè˜­é­šæ”¤", item: "å†°æ‹¿éµ", type: "ice_latte_sugar", days: [6], count: 1 ,note:"åŠ ç³–", groupId: "neighbor_l_5"},
        { loc: "æé¾å«©ä»™è‰å°é¢", name: "è³£é­šçš„å“¡å·¥", item: "å¤§ç†±ç¾", type: "large_hot_am", days: [6,0], note: "å…­çµ¦å…©å¤©éŒ¢", groupId: "other_1" },
        { loc: "è¿‘åå­—è·¯å£", name: "ç‰›è‚‰çˆ¸çˆ¸", item: "å¤§æ‹¿éµ", count: 1, type: "large_hot_latte", days: [], note: "çˆ¸çˆ¸ç²‰20g", groupId: "other_2" },
        { loc: "è¿‘åå­—è·¯å£", name: "ç‰›è‚‰å…’å­", item: "å¤§æ‹¿éµ", count: 1, type: "large_hot_latte", days: [], groupId: "other_2" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "é­šè€é—†", item: "å¤§æ‹¿éµ", type: "large_hot_latte", days: [2, 3, 5], count: 1, note: "å¯„æ¯", groupId: "other_3" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "é­šè€é—†é„°å±…(æ°´æœ)", item: "ç†±æ‹¿éµ", type: "hot_latte", days: [2, 3, 6, 0], count: 1, groupId: "other_4" }, 
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "å°è¾£æ¤’", item: "ç†±ç¾å¼", type: "hot_am", days: [], count: 1, groupId: "other_5" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "è¦è€é—†", item: "ç†±ç¾å¼",type: "hot_am", days: [2, 4, 5, 6, 0], count: 1, groupId: "other_6" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "æ¢¨å±±èœœè˜‹æœ", item: "ç†±æ‹¿éµ",tag: "ç•¶æ—¥å•", type: "hot_latte", days: [4,5], count: 1, groupId: "other_7" }, 
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "åŸéšå»Ÿå£éµé‹è¡Œ", item: "å†°ç¾å¼",  count: 2, type: "ice_am", days: [5], groupId: "other_8" }, 
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "çœ¼é¡ç™½é«®å°èœè€é—†", item: "å†°æ‰‹æ²–|é›…", type: "hand_drip",tag: "ç•¶æ—¥å•è€å®¢æˆ¶æ‰‹æ²–100", days: [4], count: 1, groupId: "other_9"  },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "æŠ“é¤…å¥³è€é—†", item: "ç†±ç¾å¼",tag: "ç•¶æ—¥å•", type: "hot_am", days: [2,4], count: 1, groupId: "other_10" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "è±åŸç´ é£Ÿ", item: "ç†±ç¾å¼", type: "hot_am", days: [3], count: 1, groupId: "other_11" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "è¿‘ä¸­å±±è·¯æ°´æœæ”¤", item: "ç†±ç¾å¼", type: "hot_am", days: [], count: 1, groupId: "other_12" },
        { loc: "éåå­—è·¯å£å³è½‰", name: "ç¦è¨˜å°é¢è±¬è‚‰", item: "ç†±ç¾å¼", type: "hot_am", days: [], count: 1, note: "å¯„æ¯", groupId: "other_13" },
        { loc: "å¸‚å ´å…§", name: "åœ‹è¯å“¥åª½åª½", item: "ç†±ç¾å¼", type: "hot_am", days: [2,5], count: 1, groupId: "other_14" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "åŸéšå»Ÿå£è²¢ä¸¸ ", item: "ç†±æ‹¿éµ", type: "hot_latte", days: [2], count: 1, groupId: "other_15" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "è²¢ä¸¸è€é—† (æ‹¿)", item: "ç†±æ‹¿éµ", type: "hot_latte", days: [3, 0], count: 1, groupId: "other_16" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "è²¢ä¸¸è€é—† (æ‰‹)", item: "ç†±æ‰‹æ²–", type: "hand_drip", days: [3, 0], count: 1, note: "ç¸½è¨ˆ$185", groupId: "other_16" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "èœè€é—†", item: "ç†±æ‹¿éµ", type: "hot_latte", days: [], count: 1, groupId: "other_17" },
        { loc: "éåå­—è·¯å£ç›´è¡Œ", name: "åŸéšå»Ÿå£è±†è…", item: "å†°ç¾å¼",   type: "ice_am", days: [6], note:"ç•¶å¤©å•",groupId: "other_18" }, 
    ];

    const typeNames = {
        hot_am: 'â˜• ç†±ç¾å¼', ice_am: 'ğŸ§Š å†°ç¾å¼', large_hot_am:"â˜•ï¸ å¤§ç†±ç¾",
        hot_latte: 'ğŸ”¥ ç†±æ‹¿éµ', hot_latte_sugar: 'ğŸ¬ ç†±æ‹¿éµ (åŠ ç³–)', 
        ice_latte_sugar: 'ğŸ­ å†°æ‹¿éµ (åŠ ç³–)', ice_latte: 'â„ï¸ å†°æ‹¿éµ', 
        large_hot_latte: 'ğŸ¥¤ å¤§ç†±æ‹¿', hand_drip: 'ğŸ’§ æ‰‹æ²–', potential_item: 'â“ å¾…ç¢ºèª'
    };

    function getTodayDateString() {
        const today = new Date();
        return today.getFullYear() + (today.getMonth() + 1).toString().padStart(2, '0') + today.getDate().toString().padStart(2, '0');
    }

    function sanitizeKeyPart(s) { return s ? s.replace(/ /g, '_').replace(/[^a-zA-Z0-9\u4e00-\u9fa5_]/g, '') : ''; }
    function getStorageKey(name, item, loc, index = 0) { return `${getTodayDateString()}_${sanitizeKeyPart(name)}_${sanitizeKeyPart(item)}_${sanitizeKeyPart(loc)}_${index}`; }
    function getAbsenceKey(groupId) { return `${getTodayDateString()}_absent_${groupId}`; }
    function escapeJsString(s) { return s ? s.replace(/\\/g, '\\\\').replace(/'/g, '\\\'') : ''; }

    window.toggleDone = function(name, item, loc, index, groupId) {
        if (isGroupAbsent(groupId)) { alert("è©²çµ„å·²æ¨™è¨˜ç‚ºã€Œç¼ºå¸­ã€ï¼"); return; }
        const key = getStorageKey(name, item, loc, index);
        localStorage.getItem(key) === 'true' ? localStorage.removeItem(key) : localStorage.setItem(key, 'true'); 
        renderOrders(); 
    }

    window.toggleAbsence = function(groupId) {
        const key = getAbsenceKey(groupId);
        if (localStorage.getItem(key) === 'true') {
            localStorage.removeItem(key); 
        } else {
            localStorage.setItem(key, 'true'); 
            const day = parseInt(document.getElementById('daySelect').value);
            customers.filter(c => c.groupId === groupId && (c.days.length === 0 || c.days.includes(day))).forEach(c => {
                for(let i = 0; i < (c.count || 1); i++) localStorage.removeItem(getStorageKey(c.name, c.item, c.loc, i));
            });
        }
        renderOrders(); 
    }

    function isItemDone(name, item, loc, index = 0) { return localStorage.getItem(getStorageKey(name, item, loc, index)) === 'true'; }
    function isGroupAbsent(groupId) { return groupId ? localStorage.getItem(getAbsenceKey(groupId)) === 'true' : false; }
    
    window.clearAllDone = function() {
        if (!confirm("ç¢ºå®šè¦é‡ç½®ä»Šæ—¥æ‰€æœ‰ç‹€æ…‹å—ï¼Ÿ")) return;
        const day = parseInt(document.getElementById('daySelect').value);
        const todaysOrders = customers.filter(c => c.days.length === 0 || c.days.includes(day));
        todaysOrders.forEach(c => {
            for(let i = 0; i < (c.count || 1); i++) localStorage.removeItem(getStorageKey(c.name, c.item, c.loc, i));
            if(c.groupId) localStorage.removeItem(getAbsenceKey(c.groupId));
        });
        expandedStats.clear();
        renderOrders();
    }

    function renderMemos(todaysOrders) {
        const memoList = document.getElementById('dynamicMemoList');
        const staticList = document.getElementById('staticMemoList');
        const dynamicMemos = todaysOrders.filter(c => c.tag && !c.tag.includes('å¯„æ¯') && !isGroupAbsent(c.groupId));
        const filterMemos = dynamicMemos.filter(c => {
             for (let i = 0; i < (c.count || 1); i++) if (!isItemDone(c.name, c.item, c.loc, i)) return true;
             return false;
        });
        if (filterMemos.length > 0) {
            let html = '<li class="dynamic-memo-title">ğŸ¯ ä»Šæ—¥éœ€ç¢ºèªï¼š</li>';
            filterMemos.forEach(c => html += `<li class="dynamic-memo-item"><b>${c.name.split('(')[0]}</b> <span class="memo-tag">${c.item}</span></li>`);
            memoList.innerHTML = html;
            staticList.classList.add('has-dynamic');
        } else {
            memoList.innerHTML = '';
            staticList.classList.remove('has-dynamic');
        }
    }

    function renderOrders() {
        const day = parseInt(document.getElementById('daySelect').value);
        const sNDiv = document.getElementById('stats-neighbor');
        const sODiv = document.getElementById('stats-other');
        
        if (day === 1) { 
            sNDiv.innerHTML = sODiv.innerHTML = '<div style="text-align:center;color:#999;padding:10px;">æœ¬æ—¥ä¼‘æ¯</div>';
            document.getElementById('clearAllBtn').disabled = true;
            document.getElementById('dynamicMemoList').innerHTML = '';
            return; 
        }
        document.getElementById('clearAllBtn').disabled = false;

        let sNeigh = {}, sOther = {};
        for (const k in typeNames) { sNeigh[k] = {total:0, done:0, orders:[]}; sOther[k] = {total:0, done:0, orders:[]}; }

        const todaysOrders = customers.filter(c => c.days.length === 0 || c.days.includes(day));
        renderMemos(todaysOrders);

        todaysOrders.forEach(c => {
            let target = (c.loc.includes("é„°å±…")) ? sNeigh : sOther;
            let isAbsent = isGroupAbsent(c.groupId);
            if (typeNames[c.type]) {
                if (!isAbsent) target[c.type].total += (c.count || 1);
                for(let i=0; i<(c.count||1); i++){
                    let done = isItemDone(c.name, c.item, c.loc, i);
                    if (done && !isAbsent) target[c.type].done++;
                    target[c.type].orders.push({...c, isDone: done, isAbsent, index: i});
                }
            }
        });

        const makeHtml = (stats, prefix) => {
            let html = '', totalN = 0, totalD = 0;
            for (const k in typeNames) {
                if (stats[k].total > 0) {
                    let s = stats[k], rem = s.total - s.done, per = Math.round((s.done/s.total)*100), id = `detail_${prefix}_${k}`;
                    expandedStats.add(id);
                    html += `<div class="stat-row" onclick="toggleStatDetail('${id}')"><span>${typeNames[k]}</span><div class="progress-counts"><span class="count-total">${s.total}</span><span class="count-remaining">å‰©: <b style="${rem===0?'color:var(--color-success)':''}">${rem}</b></span></div></div><div class="stat-row-progress"><div class="progress-fill" style="width:${per}%; background-color:${rem===0?'var(--color-success)':'var(--color-accent)'};"></div></div><div id="${id}" class="stat-detail-list" style="display:block;">${s.orders.map(o => {
                        let safe = [escapeJsString(o.name), escapeJsString(o.item), escapeJsString(o.loc), o.index, o.groupId];
                        return `<div class="stat-detail-item ${o.isAbsent?'absent':(o.isDone?'done':'')}"><span class="absence-toggle" onclick="event.stopPropagation(); toggleAbsence('${o.groupId}')">${o.isAbsent?'æ¢å¾©':'ç¼ºå¸­'}</span><div class="customer-info" onclick="toggleDone('${safe[0]}','${safe[1]}','${safe[2]}',${safe[3]},'${safe[4]}')"><span class="customer-name">${o.name}${o.count>1?` (${o.index+1}/${o.count})`:''} ${o.tag||o.note?`<span class="customer-tag">${o.tag||o.note}</span>`:''}</span><span class="customer-loc">${o.item}</span></div><input type="checkbox" ${o.isDone||o.isAbsent?'checked':''} onclick="${o.isAbsent?'event.preventDefault()':`toggleDone('${safe[0]}','${safe[1]}','${safe[2]}',${safe[3]},'${safe[4]}')`}"></div>`
                    }).join('')}</div>`;
                    totalN += s.total; totalD += s.done;
                }
            }
            if(totalN > 0) {
                let rem = totalN - totalD, per = Math.round((totalD/totalN)*100);
                html += `<div class="stat-row total"><span>ğŸ† ç¸½è¨ˆ</span><div class="progress-counts"><span class="count-total">${totalN}</span><span class="count-remaining">å‰©: <b style="${rem===0?'color:var(--color-success)':''}">${rem}</b></span></div></div><div class="stat-row-progress"><div class="progress-fill" style="width:${per}%; background-color:${rem===0?'var(--color-success)':'var(--color-total-progress)'};"></div></div>`;
            } else html = '<div style="text-align:center;color:#999;padding:10px;">ç„¡è¨‚å–®</div>';
            return html;
        };
        sNDiv.innerHTML = makeHtml(sNeigh, 'n'); sODiv.innerHTML = makeHtml(sOther, 'o');
    }

    window.toggleStatDetail = function(id) {
        const el = document.getElementById(id);
        if (el) {
            if (el.style.display === 'block') { el.style.display = 'none'; expandedStats.delete(id); }
            else { el.style.display = 'block'; expandedStats.add(id); }
        }
    }

    document.getElementById('daySelect').value = new Date().getDay();
    renderOrders();
</script>
</body>
</html>