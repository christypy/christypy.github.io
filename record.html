<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç²¾å“å’–å•¡ç´€éŒ„å™¨ v32</title>
<style>
:root {
  --bg: #f8f9fa; --card: #ffffff; --main: #5d4037; --accent: #8d6e63;
  --text: #2c1e1c; --line: #e0e0e0; --primary: #795548; --danger: #d32f2f; --share: #388e3c;
  --wait: #fff3e0; --wait-border: #ff9800; --pour: #e0f7fa; --pour-border: #00bcd4;
}
body { margin: 0; font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
.container { max-width: 1200px; margin: auto; padding: 12px; display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 768px) { .container { grid-template-columns: 1fr 1fr; } .header-full { grid-column: span 2; } .history-section { grid-column: 2; grid-row: 2 / 10; } }

.home-link-btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; margin: 10px auto 20px; background-color: var(--main); color: white !important; text-decoration: none; border-radius: 50px; font-weight: bold; width: fit-content; }

.card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
.section-title { font-weight: 800; margin-bottom: 12px; font-size: 14px; color: var(--main); display: flex; align-items: center; }
.section-title::before { content: ""; width: 4px; height: 14px; background: var(--main); margin-right: 8px; border-radius: 2px; }

/* æ ¸å¿ƒæ“ä½œå¤§å€å¡Š */
.guide-area { 
    text-align: center; border-radius: 16px; padding: 20px 10px; margin-bottom: 12px; 
    transition: all 0.2s; cursor: pointer; border: 4px solid #eee; background: #fdfdfd;
}
.guide-area.active:active { transform: scale(0.98); }
.status-pour { background: var(--pour); border-color: var(--pour-border); }
.status-wait { background: var(--wait); border-color: var(--wait-border); }

.timer-display { font-size: 56px; font-weight: 800; margin: 5px 0; font-family: monospace; color: var(--main); }
.step-hint { font-size: 18px; font-weight: bold; color: var(--main); }
.click-notice { font-size: 12px; color: #888; margin-top: 4px; }

.params-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #fdfaf9; padding: 12px; border-radius: 12px; }
.param-item { display: flex; flex-direction: column; gap: 4px; }
.param-label { font-size: 11px; color: #8d6e63; font-weight: bold; }
.param-select { width: 100%; border: 1px solid var(--line); border-radius: 8px; padding: 6px; font-size: 13px; background: white; }

.bean-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 8px; }
.bean-btn { border: 1px solid var(--line); border-radius: 8px; padding: 8px 2px; background: white; cursor: pointer; font-size: 13px; color: #666; }
.bean-btn.active { background: var(--main); color: white; border-color: var(--main); }

.mode-switch { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; background: #efebe9; padding: 4px; border-radius: 10px; }
.mode-btn { border: none; border-radius: 8px; padding: 8px; cursor: pointer; font-weight: bold; background: transparent; color: #8d6e63; }
.mode-btn.active { background: white; color: var(--main); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

.log-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; table-layout: fixed; }
.log-table th { background: #f5f5f5; padding: 8px 2px; border-bottom: 2px solid var(--line); }
.log-table td { padding: 6px 1px; text-align: center; border-bottom: 1px solid #f0f0f0; }
.log-table select { border: none; background: #f8f9fa; padding: 4px 2px; border-radius: 4px; font-size: 10px; width: 95%; }

.btn-danger-outline { background: #fff5f5; color: var(--danger); border: 1px solid #ffcdd2; width: 100%; padding: 12px; border-radius: 10px; margin-top: 20px; font-weight: bold; font-size: 13px; }
</style>
</head>
<body>

<div class="container">
  <div class="header-full" style="text-align: center;">
    <h2 style="color:var(--main); margin:15px 0 5px;">ç²¾å“å’–å•¡ç´€éŒ„å™¨ v32</h2>
    <a href="https://christypy.github.io/" class="home-link-btn">ğŸ  è¿”å›é¦–é </a>
  </div>

  <div class="card">
    <div class="section-title">æ¨¡å¼èˆ‡è±†ç¨®</div>
    <div class="mode-switch">
      <button id="mode-pour" class="mode-btn active" onclick="selectMode('pour',this)">æ‰‹æ²–æ¨¡å¼</button>
      <button id="mode-esp" class="mode-btn" onclick="selectMode('espresso',this)">ç¾©å¼æ¨¡å¼</button>
    </div>
    <div class="bean-grid" id="beanBtns"></div>
  </div>

  <div class="card">
    <div class="section-title">åˆå§‹åƒæ•¸</div>
    <div class="params-grid">
      <div class="param-item"><span class="param-label">ç²‰é‡</span><select id="dose" class="param-select" onchange="calcStats()"></select></div>
      <div class="param-item"><span class="param-label">ç ”ç£¨</span><select id="grind" class="param-select"></select></div>
      <div class="param-item" id="temp-row"><span class="param-label">æ°´æº«</span><select id="temp" class="param-select"></select></div>
    </div>
  </div>

  <div class="card">
    <div id="guideBox" class="guide-area" onclick="handleTimerAction()">
        <div id="stepName" class="step-hint">å¾…æ©Ÿä¸­</div>
        <div id="timer" class="timer-display">0:00</div>
        <div id="clickNotice" class="click-notice">é»æ“Šä¸‹æ–¹é–‹å§‹æŒ‰éˆ•</div>
    </div>
    
    <div style="display:grid; grid-template-columns: 3fr 1fr; gap:10px;">
        <button id="mainTimerBtn" onclick="toggleTimer()" style="background:var(--main); color:white; border:none; font-weight:bold; font-size:16px; border-radius:12px; height:54px;">é–‹å§‹æ²–ç…®</button>
        <button onclick="resetTimer()" style="color:#999; border:none; background:none; font-weight:bold;">é‡ç½®</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title">æ²–ç…®éç¨‹ç´€éŒ„</div>
    <div style="overflow-x: auto;">
      <table class="log-table">
        <thead id="logHead"></thead>
        <tbody id="logs"></tbody>
        <tfoot id="logFoot"></tfoot>
      </table>
    </div>
    <div style="margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <select id="eval-strength" class="param-select"><option>æ¿ƒåº¦å‰›å¥½</option><option>å¤ªæ¿ƒ</option><option>å¤ªæ·¡(æ°´æ„Ÿ)</option></select>
        <select id="eval-balance" class="param-select"><option>é…¸ç”œå¹³è¡¡</option><option>å¤ªé…¸</option><option>è‹¦æ¾€</option></select>
    </div>
    <button onclick="saveRecord()" style="background:var(--main); color:white; width:100%; border:none; padding:15px; border-radius:12px; margin-top:15px; font-weight:bold; font-size:16px;">å„²å­˜æœ¬æ¬¡æ²–ç…®</button>
  </div>

  <div class="card history-section">
    <div class="section-title">æ­·å²æ—¥èªŒ</div>
    <div id="pour-history"></div>
    <div id="esp-history"></div>
    <button class="btn-danger-outline" onclick="clearAllHistory()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
  </div>
</div>

<script>
const baseBeans=['è¦º','èŠ±','å¯¶','è©','é›…','éœ','æœ','ç¦','æŸ”','å®š','çœŸ','æ½¤'];
let mode='pour', bean='è¦º', startTime=null, elapsed=0, timerInt=null, pours=[], isRunning=false;
let currentAction = "æ³¨æ°´"; 
let finalStats = { liquid: 0, ratio: '-', time: '0:00' };

window.onload = () => { initSelectors(); selectMode('pour', document.getElementById('mode-pour')); renderHistory(); };

function initSelectors() {
    const d = document.getElementById('dose');
    for(let i=12; i<=30; i+=0.5) { let o = new Option(i+'g', i); if(i===20) o.selected=true; d.add(o); }
    const g = document.getElementById('grind');
    for(let i=1; i<=15; i+=0.5) { let o = new Option(i, i); if(i===6) o.selected=true; g.add(o); }
    const t = document.getElementById('temp');
    for(let i=80; i<=99; i++) { let o = new Option(i+'Â°C', i); if(i===93) o.selected=true; t.add(o); }
}

function selectMode(m, btn) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('temp-row').style.visibility = (m === 'espresso') ? 'hidden' : 'visible';
    renderTableHead(); buildBeans(); resetTimer();
}

function renderTableHead() {
    const head = document.getElementById('logHead');
    head.innerHTML = (mode === 'pour') ? 
        `<tr><th width="15%">å‹•ä½œ</th><th width="15%">è€—æ™‚</th><th width="15%">ç¸½æ™‚</th><th width="20%">è·¯å¾‘</th><th width="20%">ç´¯è¨ˆ</th><th width="15%">å¢</th></tr>` :
        `<tr><th>éšæ®µ</th><th>è€—æ™‚</th><th>ç¸½æ™‚é–“</th></tr>`;
}

function buildBeans() {
    const wrap = document.getElementById('beanBtns'); wrap.innerHTML = '';
    const list = (mode === 'espresso') ? [...baseBeans, 'æ··è±†'] : baseBeans;
    list.forEach(b => {
        const btn = document.createElement('button'); btn.textContent = b; btn.className = 'bean-btn';
        if (b === bean) btn.classList.add('active');
        btn.onclick = () => { bean = b; wrap.querySelectorAll('.bean-btn').forEach(x => x.classList.remove('active')); btn.classList.add('active'); };
        wrap.appendChild(btn);
    });
}

function toggleTimer() {
    const btn = document.getElementById('mainTimerBtn');
    if (!isRunning) {
        isRunning = true;
        startTime = Date.now();
        timerInt = setInterval(() => {
            elapsed = Date.now() - startTime;
            document.getElementById('timer').textContent = formatTime(elapsed);
        }, 100);
        btn.textContent = "çµæŸæ²–ç…®";
        btn.classList.add('btn-danger');
        
        // æ‰‹æ²–æ¨¡å¼ï¼šæŒ‰ä¸‹é–‹å§‹ = è‡ªå‹•ç™¼å‹•ç¬¬ä¸€ç­†æ³¨æ°´
        if(mode === 'pour') {
            pours.push({
                name: "æ³¨æ°´", total: "0:00", absMs: 0, diff: "0:00",
                path: 'ä¸­å¿ƒ', cumLiquid: 0, diffLiquid: 0
            });
            currentAction = "æ–·æ°´"; 
            renderLogs();
        }
        updateGuideUI();
    } else {
        finalizeBrew();
    }
}

function handleTimerAction() {
    if (!isRunning) return;
    if (mode === 'pour') {
        const nowMs = elapsed;
        const lastMs = pours[pours.length-1].absMs;
        pours.push({
            name: currentAction,
            total: formatTime(nowMs),
            absMs: nowMs,
            diff: formatTime(nowMs - lastMs),
            path: (currentAction === 'æ³¨æ°´' ? 'å°åœˆ' : '-'), cumLiquid: 0, diffLiquid: 0
        });
        currentAction = (currentAction === "æ³¨æ°´") ? "æ–·æ°´" : "æ³¨æ°´";
        updateGuideUI();
        renderLogs();
    } else if (mode === 'espresso' && pours.length === 0) {
        pours.push({ name: 'é æµ¸', total: formatTime(elapsed), diff: (elapsed/1000).toFixed(1)+'s', absSec: elapsed/1000 });
        document.getElementById('stepName').textContent = "æ­£åœ¨èƒå–ä¸­...";
        renderLogs();
    }
}

function updateGuideUI() {
    const box = document.getElementById('guideBox');
    const nameEl = document.getElementById('stepName');
    const noticeEl = document.getElementById('clickNotice');
    
    if (mode === 'pour') {
        box.classList.add('active');
        nameEl.textContent = (currentAction === "æ³¨æ°´") ? "æ­£åœ¨ç­‰å¾…ä¸­..." : "æ­£åœ¨æ³¨æ°´ä¸­...";
        noticeEl.textContent = "é»æ“Šé¢æ¿ç´€éŒ„ã€Œ" + currentAction + "ã€";
        box.className = "guide-area active " + (currentAction === "æ³¨æ°´" ? "status-wait" : "status-pour");
    } else {
        nameEl.textContent = "æ­£åœ¨æ²–ç…®";
        noticeEl.textContent = (pours.length === 0) ? "é»æ“Šé¢æ¿ç´€éŒ„ã€Œé æµ¸ã€" : "è§€å¯Ÿæµé€Ÿä¸­";
        box.className = "guide-area";
    }
}

function finalizeBrew() {
    clearInterval(timerInt);
    isRunning = false;
    finalStats.time = formatTime(elapsed);
    if (mode === 'espresso') {
        const totalSec = elapsed / 1000;
        if (pours.length === 1) pours.push({ name: 'èƒå–', total: finalStats.time, diff: (totalSec - pours[0].absSec).toFixed(1)+'s' });
        if (finalStats.liquid === 0) updateEspLiquid(40);
    }
    document.getElementById('mainTimerBtn').textContent = "é–‹å§‹æ²–ç…®";
    document.getElementById('mainTimerBtn').classList.remove('btn-danger');
    document.getElementById('stepName').textContent = "çµæŸ";
    document.getElementById('guideBox').className = "guide-area";
    calcStats();
    renderLogs();
}

function resetTimer() {
    clearInterval(timerInt);
    isRunning = false; elapsed = 0; pours = []; currentAction = "æ³¨æ°´";
    finalStats = { liquid: 0, ratio: '-', time: '0:00' };
    document.getElementById('timer').textContent = "0:00";
    document.getElementById('stepName').textContent = "å¾…æ©Ÿä¸­";
    document.getElementById('guideBox').className = "guide-area";
    document.getElementById('mainTimerBtn').textContent = "é–‹å§‹æ²–ç…®";
    document.getElementById('mainTimerBtn').classList.remove('btn-danger');
    renderLogs();
}

function updateDetail(idx, field, val) {
    pours[idx][field] = (field === 'cumLiquid') ? parseInt(val) : val;
    calcStats();
    renderLogs();
}

function calcStats() {
    const dose = parseFloat(document.getElementById('dose').value);
    for (let i = 0; i < pours.length; i++) {
        const prevCum = (i === 0) ? 0 : (pours[i-1].cumLiquid || 0);
        pours[i].diffLiquid = (pours[i].cumLiquid > 0) ? (pours[i].cumLiquid - prevCum) : 0;
    }
    if (pours.length > 0 && mode === 'pour') {
        const lastVal = pours[pours.length-1].cumLiquid;
        finalStats.liquid = lastVal;
        finalStats.ratio = lastVal > 0 ? `1:${(lastVal / dose).toFixed(1)}` : '-';
    }
}

function renderLogs() {
    const wrap = document.getElementById('logs'); wrap.innerHTML = '';
    const foot = document.getElementById('logFoot'); foot.innerHTML = '';
    pours.forEach((p, i) => {
        const tr = document.createElement('tr');
        if (mode === 'pour') {
            let pathOpt = p.name==='æ–·æ°´' ? '-' : `<select onchange="updateDetail(${i},'path',this.value)">` + ['ä¸­å¿ƒ','å°åœˆ','å¤§åœˆ'].map(v=>`<option ${p.path===v?'selected':''}>${v}</option>`).join('') + `</select>`;
            let cumOpt = `<select onchange="updateDetail(${i},'cumLiquid',this.value)"><option value="0">-</option>`;
            for(let j=20; j<=450; j+=5) cumOpt += `<option value="${j}" ${p.cumLiquid==j?'selected':''}>${j}g</option>`;
            cumOpt += `</select>`;
            tr.innerHTML=`<td>${p.name}</td><td>${p.diff}</td><td>${p.total}</td><td>${pathOpt}</td><td>${cumOpt}</td><td>+${p.diffLiquid}</td>`;
        } else {
            tr.innerHTML=`<td>${p.name}</td><td>${p.diff}</td><td>${p.total}</td>`;
        }
        wrap.appendChild(tr);
    });
    if (mode === 'pour') {
        foot.innerHTML = `<tr style="font-weight:bold; background:#f9f9f9;"><td colspan="3">ç¸½è¨ˆ: ${finalStats.liquid}g</td><td colspan="3">ç²‰æ°´æ¯”: ${finalStats.ratio}</td></tr>`;
    }
}

function updateEspLiquid(val) {
    finalStats.liquid = parseInt(val);
    const dose = parseFloat(document.getElementById('dose').value);
    finalStats.ratio = `1:${(finalStats.liquid / dose).toFixed(1)}`;
    renderLogs();
}

function saveRecord() {
    if (pours.length === 0) return;
    const key = (mode === 'pour') ? 'pourLogs' : 'espLogs';
    const history = JSON.parse(localStorage.getItem(key) || '[]');
    history.unshift({
        time: new Date().toLocaleString('zh-TW',{hour12:false, month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
        bean, dose: document.getElementById('dose').value, grind: document.getElementById('grind').value,
        temp: document.getElementById('temp').value, target: finalStats.liquid,
        pours: JSON.parse(JSON.stringify(pours)), mode, finalStats: {...finalStats},
        evaluation: { strength: document.getElementById('eval-strength').value, balance: document.getElementById('eval-balance').value }
    });
    localStorage.setItem(key, JSON.stringify(history));
    renderHistory(); resetTimer();
}

function renderHistory() {
    ['pour-history','esp-history'].forEach(id => document.getElementById(id).innerHTML='');
    ['pourLogs','espLogs'].forEach(key => {
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        const wrap = document.getElementById(key==='pourLogs' ? 'pour-history' : 'esp-history');
        list.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'card'; div.style.marginBottom = '10px'; div.style.fontSize = '12px';
            div.innerHTML = `<b>${item.bean}</b> <small>${item.time}</small> (${item.target}g / ${item.finalStats.ratio})<br>
            <button onclick="deleteItem('${key}',${idx})" style="border:none; background:none; color:red; float:right;">âœ•</button>`;
            wrap.appendChild(div);
        });
    });
}

function deleteItem(k, i) { if(confirm("åˆªé™¤ï¼Ÿ")){ const h=JSON.parse(localStorage.getItem(k)); h.splice(i,1); localStorage.setItem(k,JSON.stringify(h)); renderHistory(); } }
function clearAllHistory() { if(confirm("æ¸…ç©ºï¼Ÿ")){ localStorage.clear(); renderHistory(); } }

function formatTime(ms) {
    const s = Math.floor(ms / 1000);
    return `${Math.floor(s/60)}:${('0'+(s%60)).slice(-2)}`;
}
</script>
</body>
</html>