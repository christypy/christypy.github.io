<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç²¾å“å’–å•¡ç´€éŒ„å™¨ v43</title>
<style>
:root {
  --bg: #f8f9fa; --card: #ffffff; --main: #5d4037; --accent: #8d6e63;
  --text: #2c1e1c; --line: #e0e0e0; --primary: #795548; --danger: #d32f2f;
  --wait-border: #ff9800; --pour-border: #00bcd4;
}
body { margin: 0; font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; font-size: 16px; }
.container { max-width: 1200px; margin: auto; padding: 15px; display: grid; grid-template-columns: 1fr; gap: 15px; }
@media (min-width: 768px) { .container { grid-template-columns: 1fr 1fr; } .header-full { grid-column: span 2; } .history-section { grid-column: 2; grid-row: 2 / 10; } }

.home-link-btn { display: inline-flex; align-items: center; justify-content: center; padding: 14px 28px; margin: 10px auto 20px; background-color: var(--main); color: white !important; text-decoration: none; border-radius: 50px; font-weight: bold; width: fit-content; font-size: 16px; }

.card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.05); }
.section-title { font-weight: 800; margin-bottom: 15px; font-size: 16px; color: var(--main); display: flex; align-items: center; }
.section-title::before { content: ""; width: 5px; height: 18px; background: var(--main); margin-right: 10px; border-radius: 3px; }

.guide-area { text-align: center; border-radius: 20px; padding: 25px 15px; margin-bottom: 15px; border: 4px solid #eee; background: #fdfdfd; cursor: pointer; transition: border-color 0.3s; }
.timer-display { font-size: 64px; font-weight: 800; margin: 8px 0; font-family: monospace; color: var(--main); }
.step-hint { font-size: 20px; font-weight: bold; color: var(--main); min-height: 30px; }

.params-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; background: #fdfaf9; padding: 15px; border-radius: 15px; }
.param-item { display: flex; flex-direction: column; gap: 6px; }
.param-label { font-size: 13px; color: #8d6e63; font-weight: bold; }
.param-select { width: 100%; border: 1px solid var(--line); border-radius: 10px; padding: 10px; font-size: 15px; background: white; -webkit-appearance: none; }

.bean-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
.bean-btn { border: 1px solid var(--line); border-radius: 10px; padding: 12px 2px; background: white; cursor: pointer; font-size: 15px; color: #666; font-weight: 500; }
.bean-btn.active { background: var(--main); color: white; border-color: var(--main); }

.mode-switch { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; background: #efebe9; padding: 5px; border-radius: 12px; }
.mode-btn { border: none; border-radius: 10px; padding: 12px; cursor: pointer; font-weight: bold; font-size: 16px; background: transparent; color: #8d6e63; }
.mode-btn.active { background: white; color: var(--main); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }

.log-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
.log-table th { background: #f5f5f5; padding: 12px 5px; border-bottom: 2px solid var(--line); text-align: center; }
.log-table td { padding: 12px 5px; text-align: center; border-bottom: 1px solid #f0f0f0; }
.log-table select { width: 100%; padding: 8px 4px; border: 1px solid #ddd; border-radius: 6px; background: #fff; font-size: 14px; }

.stats-footer { background: #efebe9; padding: 20px; border-radius: 15px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; text-align: center; }
.stats-box { display: flex; flex-direction: column; gap: 6px; }
.stats-label { font-size: 13px; color: #795548; font-weight: bold; }
.stats-value { font-size: 22px; font-weight: 800; color: #5d4037; }

/* æ­·å²ç´€éŒ„å±•é–‹æ¨£å¼ */
.history-item { cursor: pointer; transition: background 0.2s; position: relative; }
.history-detail { display: none; padding-top: 10px; border-top: 1px dashed #ddd; margin-top: 10px; font-size: 13px; color: #555; }
.history-detail table { width: 100%; border-collapse: collapse; margin-top: 5px; }
.history-detail th, .history-detail td { border: 1px solid #eee; padding: 4px; text-align: center; }

.btn-add-step { background: #fff; color: var(--main); border: 2px dashed var(--main); width: 100%; padding: 15px; border-radius: 12px; margin-top: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
.btn-danger-outline { background: #fff5f5; color: var(--danger); border: 1px solid #ffcdd2; width: 100%; padding: 15px; border-radius: 12px; margin-top: 25px; font-weight: bold; font-size: 15px; }
.select-time { width: 85px !important; }
</style>
</head>
<body>

<div class="container">
  <div class="header-full" style="text-align: center;">
    <h2 style="color:var(--main); margin:20px 0 10px;">ç²¾å“å’–å•¡ç´€éŒ„å™¨ v43</h2>
    <a href="https://christypy.github.io/" class="home-link-btn">ğŸ  è¿”å›é¦–é </a>
  </div>

  <div class="card">
    <div class="section-title">æ¨¡å¼èˆ‡è±†ç¨®</div>
    <div class="mode-switch">
      <button id="mode-pour" class="mode-btn active" onclick="selectMode('pour',this)">æ‰‹æ²–æ¨¡å¼</button>
      <button id="mode-esp" class="mode-btn" onclick="selectMode('espresso',this)">ç¾©å¼æ¨¡å¼</button>
    </div>
    <div class="bean-grid" id="beanBtns"></div>
  </div>

  <div class="card">
    <div class="section-title">åˆå§‹åƒæ•¸</div>
    <div class="params-grid">
      <div class="param-item"><span class="param-label">ç²‰é‡</span><select id="dose" class="param-select" onchange="calcStats()"></select></div>
      <div class="param-item"><span class="param-label">ç ”ç£¨</span><select id="grind" class="param-select"></select></div>
      <div class="param-item" id="temp-row"><span class="param-label">æ°´æº«</span><select id="temp" class="param-select"></select></div>
    </div>
  </div>

  <div class="card">
    <div id="guideBox" class="guide-area" onclick="handleTimerAction()">
        <div id="stepName" class="step-hint">å¾…æ©Ÿä¸­</div>
        <div id="timer" class="timer-display">0:00</div>
    </div>
    <div style="display:grid; grid-template-columns: 3fr 1fr; gap:12px;">
        <button id="mainTimerBtn" onclick="toggleTimer()" style="background:var(--main); color:white; border:none; font-weight:bold; font-size:18px; border-radius:15px; height:60px;">é–‹å§‹æ²–ç…®</button>
        <button onclick="resetTimer()" style="color:#999; border:none; background:none; font-weight:bold; font-size:16px;">é‡ç½®</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title">æ²–ç…®éç¨‹ç´€éŒ„</div>
    <div style="overflow-x: auto;">
      <table class="log-table">
        <thead id="logHead"></thead>
        <tbody id="logs"></tbody>
      </table>
    </div>
    <div id="manual-tools" style="display:none;">
        <button class="btn-add-step" onclick="addManualPourCycle()">â• æ‰‹å‹•æ–°å¢æ³¨æ°´ (è·¯å¾‘+ç¸½é‡)</button>
    </div>

    <div class="stats-footer">
        <div class="stats-box"><div class="stats-label">ç¸½æ¶²é«”é‡</div><div class="stats-value" id="stats-liquid-display">0g</div></div>
        <div class="stats-box"><div class="stats-label">ç²‰æ°´æ¯”</div><div class="stats-value" id="stats-ratio-display">1:-</div></div>
    </div>
    <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <select id="eval-strength" class="param-select"><option>æ¿ƒåº¦å‰›å¥½</option><option>å¤ªæ¿ƒ</option><option>å¤ªæ·¡</option></select>
        <select id="eval-balance" class="param-select"><option>é…¸ç”œå¹³è¡¡</option><option>å¤ªé…¸</option><option>è‹¦æ¾€</option></select>
    </div>
    <button onclick="saveRecord()" style="background:var(--main); color:white; width:100%; border:none; padding:18px; border-radius:15px; margin-top:20px; font-weight:bold; font-size:18px;">å„²å­˜æœ¬æ¬¡ç´€éŒ„</button>
  </div>

  <div class="card history-section">
    <div class="section-title">æ­·å²æ—¥èªŒ (é»æ“Šå±•é–‹è©³ç´°)</div>
    <div id="pour-history"></div>
    <div id="esp-history"></div>
    <button class="btn-danger-outline" onclick="clearAllHistory()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
  </div>
</div>

<script>
const baseBeans=['è¦º','èŠ±','å¯¶','è©','é›…','éœ','æœ','ç¦','æŸ”','å®š','çœŸ','æ½¤'];
let mode='pour', bean='è¦º', startTime=null, elapsed=0, timerInt=null, pours=[], isRunning=false;
let currentAction = "æ³¨æ°´", finalStats = { liquid: 0, ratio: '-', time: '0:00' };

window.onload = () => { initSelectors(); selectMode('pour', document.getElementById('mode-pour')); renderHistory(); };

function initSelectors() {
    const d = document.getElementById('dose');
    for(let i=12; i<=30; i+=0.5) { let o = new Option(i+'g', i); if(i===20) o.selected=true; d.add(o); }
    const g = document.getElementById('grind');
    for(let i=1; i<=15; i+=0.5) { let o = new Option(i, i); if(i===6) o.selected=true; g.add(o); }
    const t = document.getElementById('temp');
    for(let i=80; i<=99; i++) { let o = new Option(i+'Â°C', i); if(i===93) o.selected=true; t.add(o); }
}

function selectMode(m, btn) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('temp-row').style.visibility = (m === 'espresso') ? 'hidden' : 'visible';
    document.getElementById('manual-tools').style.display = (m === 'pour') ? 'block' : 'none';
    resetTimer(); 
}

function renderTableHead() {
    const head = document.getElementById('logHead');
    head.innerHTML = (mode === 'pour') ? 
        `<tr><th width="15%">å‹•ä½œ</th><th width="22%">ç¸½æ™‚</th><th width="20%">è·¯å¾‘</th><th width="23%">ç´¯ç©</th><th width="20%">å¢é‡</th></tr>` :
        `<tr><th>éšæ®µ</th><th>è€—æ™‚</th><th>ç¸½æ™‚é–“</th></tr>`;
}

function buildBeans() {
    const wrap = document.getElementById('beanBtns'); wrap.innerHTML = '';
    const list = (mode === 'espresso') ? [...baseBeans, 'æ··è±†'] : baseBeans;
    list.forEach(b => {
        const btn = document.createElement('button'); btn.textContent = b; btn.className = 'bean-btn';
        if (b === bean) btn.classList.add('active');
        btn.onclick = () => { bean = b; wrap.querySelectorAll('.bean-btn').forEach(x => x.classList.remove('active')); btn.classList.add('active'); };
        wrap.appendChild(btn);
    });
}

function toggleTimer() {
    if (!isRunning) {
        isRunning = true;
        startTime = Date.now() - elapsed;
        timerInt = setInterval(() => {
            elapsed = Date.now() - startTime;
            document.getElementById('timer').textContent = formatTime(elapsed);
        }, 100);
        document.getElementById('mainTimerBtn').textContent = "çµæŸæ²–ç…®";
        document.getElementById('mainTimerBtn').style.background = "var(--danger)";
        
        if(mode === 'pour' && pours.length === 0) {
            pours.push({ name: "æ³¨æ°´", total: "0:00", absMs: 0, path: 'å¤§åœˆ', cumLiquid: 0, diffLiquid: 0, isManual: false });
            currentAction = "æ–·æ°´";
        }
        updateStatusText();
        renderLogs();
    } else {
        finalizeBrew();
    }
}

function handleTimerAction() {
    if (!isRunning) return;
    const nowMs = elapsed;
    if (mode === 'pour') {
        pours.push({ name: currentAction, total: formatTime(nowMs), absMs: nowMs, path: currentAction==='æ³¨æ°´'?'å¤§åœˆ':'-', cumLiquid: 0, diffLiquid: 0, isManual: false });
        currentAction = (currentAction === "æ³¨æ°´") ? "æ–·æ°´" : "æ³¨æ°´";
    } else if (mode === 'espresso' && pours.length === 0) {
        pours.push({ name: 'é æµ¸', total: formatTime(nowMs), diff: (nowMs/1000).toFixed(1)+'s', absSec: nowMs/1000, isManual: false });
    }
    updateStatusText();
    renderLogs();
}

function updateStatusText() {
    const stepEl = document.getElementById('stepName');
    const box = document.getElementById('guideBox');
    if (!isRunning) {
        stepEl.textContent = "å¾…æ©Ÿä¸­";
        box.style.borderColor = "#eee";
        return;
    }
    if (mode === 'pour') {
        stepEl.textContent = (currentAction === "æ³¨æ°´") ? "æ­£åœ¨æ–·æ°´..." : "æ­£åœ¨æ³¨æ°´ä¸­...";
        box.style.borderColor = (currentAction === "æ³¨æ°´") ? "var(--wait-border)" : "var(--pour-border)";
    } else {
        stepEl.textContent = "èƒå–ä¸­";
    }
}

function addManualPourCycle() {
    const lastT = pours.length > 0 ? pours[pours.length-1].total : "0:00";
    // æ‰‹å‹•æ–°å¢çš„åˆ—æ¨™è¨˜ isManual: true
    pours.push({ name: "æ³¨æ°´", total: lastT, absMs: 0, path: 'å¤§åœˆ', cumLiquid: 0, diffLiquid: 0, isManual: true });
    pours.push({ name: "æ–·æ°´", total: lastT, absMs: 0, path: '-', cumLiquid: 0, diffLiquid: 0, isManual: true });
    renderLogs();
}

function finalizeBrew() {
    clearInterval(timerInt); 
    isRunning = false;
    finalStats.time = formatTime(elapsed);
    if (mode === 'espresso') {
        const totalSec = (elapsed / 1000).toFixed(1);
        if (pours.length === 0) {
            pours.push({ name: 'èƒå–', total: finalStats.time, diff: totalSec + 's', absSec: parseFloat(totalSec), isManual: false });
        } else if (pours.length === 1) {
            const bSec = (parseFloat(totalSec) - pours[0].absSec).toFixed(1);
            pours.push({ name: 'èƒå–', total: finalStats.time, diff: bSec + 's', absSec: parseFloat(bSec), isManual: false });
        }
    }
    document.getElementById('mainTimerBtn').textContent = "ç¹¼çºŒ/é–‹å§‹";
    document.getElementById('mainTimerBtn').style.background = "var(--main)";
    updateStatusText();
    calcStats(); 
    renderLogs();
}

function resetTimer() {
    clearInterval(timerInt); isRunning = false; elapsed = 0; currentAction = "æ³¨æ°´";
    if (mode === 'espresso') {
        finalStats = { liquid: 60, ratio: '-', time: '0:00' };
        pours = [{ name: 'é æµ¸', total: '0:00', diff: '0.0s', absSec: 0, isManual: true }, { name: 'èƒå–', total: '0:00', diff: '0.0s', absSec: 0, isManual: true }];
    } else {
        finalStats = { liquid: 0, ratio: '-', time: '0:00' };
        pours = [];
    }
    document.getElementById('timer').textContent = "0:00";
    document.getElementById('mainTimerBtn').textContent = "é–‹å§‹æ²–ç…®";
    updateStatusText();
    renderTableHead(); buildBeans(); renderLogs();
}

function updateDetail(idx, field, val) {
    pours[idx][field] = (field === 'cumLiquid') ? parseInt(val) : val;
    calcStats(); renderLogs();
}

function updateEspTime(idx, val) {
    pours[idx].diff = val + 's'; pours[idx].absSec = parseFloat(val);
    let running = 0;
    pours.forEach(p => { running += p.absSec; p.total = formatTime(running * 1000); });
    finalStats.time = pours[pours.length-1].total;
    calcStats(); renderLogs();
}

function calcStats() {
    const d = parseFloat(document.getElementById('dose').value);
    if (mode === 'pour') {
        let last = 0;
        pours.forEach(p => {
            if (p.name === 'æ–·æ°´') {
                p.diffLiquid = p.cumLiquid > 0 ? (p.cumLiquid - last) : 0;
                last = p.cumLiquid > 0 ? p.cumLiquid : last;
            } else { p.diffLiquid = 0; }
        });
        const lp = [...pours].reverse().find(p => p.name === 'æ–·æ°´');
        finalStats.liquid = lp ? lp.cumLiquid : 0;
    }
    finalStats.ratio = finalStats.liquid > 0 ? `1:${(finalStats.liquid / d).toFixed(1)}` : '-';
    document.getElementById('stats-liquid-display').textContent = finalStats.liquid + 'g';
    document.getElementById('stats-ratio-display').textContent = finalStats.ratio;
}

function renderLogs() {
    const wrap = document.getElementById('logs'); wrap.innerHTML = '';
    pours.forEach((p, i) => {
        const tr = document.createElement('tr');
        if (mode === 'pour') {
            // åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹å‹•æ¨¡å¼ç”¢ç”Ÿçš„åˆ—ï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºæ™‚é–“ä¸‹æ‹‰é¸å–®
            let timeUI = p.total;
            if (!isRunning && p.isManual) {
                timeUI = `<select class="select-time" onchange="updateDetail(${i},'total',this.value)">`;
                for(let m=0; m<=5; m++) for(let s=0; s<60; s+=5) {
                    let t = `${m}:${s<10?'0'+s:s}`;
                    timeUI += `<option value="${t}" ${p.total===t?'selected':''}>${t}</option>`;
                }
                timeUI += `</select>`;
            }

            let pathO = p.name==='æ–·æ°´'?'-':`<select onchange="updateDetail(${i},'path',this.value)">${['å¤§åœˆ','å°åœˆ','ä¸­å¿ƒ'].map(v=>`<option ${p.path===v?'selected':''}>${v}</option>`).join('')}</select>`;
            let cumO = p.name==='æ–·æ°´' ? `<select onchange="updateDetail(${i},'cumLiquid',this.value)"><option value="0">-</option>` + Array.from({length:44},(_,j)=>(j+2)*10).map(v=>`<option value="${v}" ${p.cumLiquid==v?'selected':''}>${v}g</option>`).join('') + `</select>` : '-';
            tr.innerHTML=`<td><b>${p.name}</b></td><td>${timeUI}</td><td>${pathO}</td><td>${cumO}</td><td>${p.diffLiquid?'+'+p.diffLiquid:'-'}</td>`;
        } else {
            // ç¾©å¼æ¨¡å¼é è¨­çš†å¯å¾®èª¿ç§’æ•¸
            let dOpt = `<select onchange="updateEspTime(${i},this.value)">` + Array.from({length:121},(_,s)=>(s*0.5).toFixed(1)).map(v=>`<option value="${v}" ${p.diff==v+'s'?'selected':''}>${v}s</option>`).join('') + `</select>`;
            tr.innerHTML=`<td>${p.name}</td><td>${dOpt}</td><td>${p.total}</td>`;
        }
        wrap.appendChild(tr);
    });
}

function saveRecord() {
    if (pours.length === 0 || finalStats.liquid === 0) return alert("æ•¸æ“šä¸å®Œæ•´");
    const key = (mode === 'pour') ? 'pourLogs' : 'espLogs';
    const history = JSON.parse(localStorage.getItem(key) || '[]');
    history.unshift({
        time: new Date().toLocaleString('zh-TW',{hour12:false, month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
        bean, dose: document.getElementById('dose').value, grind: document.getElementById('grind').value,
        target: finalStats.liquid, ratio: finalStats.ratio, totalTime: (pours.length>0?pours[pours.length-1].total:"0:00"),
        eval: [document.getElementById('eval-strength').value, document.getElementById('eval-balance').value],
        details: JSON.parse(JSON.stringify(pours))
    });
    localStorage.setItem(key, JSON.stringify(history));
    renderHistory(); 
    resetTimer();
}

function renderHistory() {
    ['pourLogs','espLogs'].forEach(key => {
        const wrap = document.getElementById(key==='pourLogs' ? 'pour-history' : 'esp-history');
        wrap.innerHTML = '';
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        list.forEach((item, idx) => {
            const div = document.createElement('div'); div.className = 'card history-item';
            div.onclick = (e) => { 
                if(e.target.tagName !== 'BUTTON') {
                    const d = div.querySelector('.history-detail');
                    d.style.display = (d.style.display === 'block') ? 'none' : 'block';
                }
            };
            let detailTable = `<table><tr>${key==='pourLogs'?'<th>å‹•ä½œ</th><th>æ™‚é–“</th><th>è·¯å¾‘</th><th>ç´¯ç©</th>':'<th>éšæ®µ</th><th>è€—æ™‚</th><th>ç¸½æ™‚</th>'}</tr>`;
            item.details.forEach(p => {
                detailTable += key==='pourLogs' ? 
                    `<tr><td>${p.name}</td><td>${p.total}</td><td>${p.path}</td><td>${p.cumLiquid}g</td></tr>` :
                    `<tr><td>${p.name}</td><td>${p.diff}</td><td>${p.total}</td></tr>`;
            });
            detailTable += `</table>`;
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${item.bean}</b> <small>${item.time}</small></div>
                    <button onclick="deleteItem('${key}',${idx})" style="border:none; background:none; color:red; font-size:18px;">âœ•</button>
                </div>
                <div style="font-size:14px; margin:5px 0;">${item.target}g (${item.ratio}) | ${item.totalTime} | ${item.grind}æ ¼</div>
                <div class="history-detail">
                    <div>è©•èªï¼š${item.eval.join(' / ')} | ç²‰é‡ï¼š${item.dose}g</div>
                    ${detailTable}
                </div>`;
            wrap.appendChild(div);
        });
    });
}
function deleteItem(k, i) { if(confirm("åˆªé™¤ï¼Ÿ")){ const h=JSON.parse(localStorage.getItem(k)); h.splice(i,1); localStorage.setItem(k,JSON.stringify(h)); renderHistory(); } }
function clearAllHistory() { if(confirm("æ¸…ç©ºï¼Ÿ")){ localStorage.clear(); renderHistory(); } }
function formatTime(ms) { const s=Math.floor(ms/1000); return `${Math.floor(s/60)}:${('0'+(s%60)).slice(-2)}`; }
</script>
</body>
</html>