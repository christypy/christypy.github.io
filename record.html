<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç²¾å“å’–å•¡ç´€éŒ„å™¨ v63.5 - å¤§å­—é«”æ˜Ÿæ˜Ÿç‰ˆ</title>
<style>
:root {
  --bg: #fdfaf7; --card: #ffffff; --main: #5d4037; --accent: #c6a49a;
  --text: #3e2723; --line: #ece0d1; --primary: #8d6e63; --danger: #d32f2f;
  --success: #43a047; --star: #ffca28; --info: #1976d2; --esp-bg: #3e2723;
}
body { margin: 0; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); font-size: 18px; -webkit-tap-highlight-color: transparent; }
.container { max-width: 1200px; margin: auto; padding: 20px; display: grid; grid-template-columns: 1fr; gap: 25px; }
@media (min-width: 992px) { .container { grid-template-columns: 1.1fr 0.9fr; } .header-full { grid-column: span 2; } }

/* æŒ‰éˆ•èˆ‡å…ƒä»¶ */
.tab-btn { flex: 1; padding: 16px; border: none; border-radius: 18px; background: #efebe9; font-weight: 800; cursor: pointer; transition: 0.2s; color: #8d6e63; font-size: 18px; }
.tab-btn.active.pour { background: var(--main); color: white; box-shadow: 0 4px 12px rgba(93,64,55,0.3); }
.tab-btn.active.esp { background: var(--esp-bg); color: white; box-shadow: 0 4px 12px rgba(62,39,35,0.3); }

.click-box { display: block; background: #fff; border: 2px solid var(--line); color: var(--main); padding: 15px; border-radius: 16px; font-weight: 900; cursor: pointer; text-align: center; font-size: 20px; }
.click-box.empty { border-color: var(--danger); color: var(--danger); }

.card { background: var(--card); border-radius: 28px; padding: 25px; box-shadow: 0 10px 40px rgba(93,64,55,0.08); }
.section-title { font-weight: 900; margin-bottom: 20px; font-size: 22px; color: var(--main); border-left: 8px solid var(--main); padding-left: 15px; }

/* è¡¨æ ¼å¤§å­—é«” */
.log-table { width: 100%; border-collapse: collapse; font-size: 15px; table-layout: fixed; }
.log-table th { padding: 12px 2px; border-bottom: 3px solid var(--line); background: #fbf9f7; color: #8d6e63; }
.log-table td { padding: 15px 2px; text-align: center; border-bottom: 1px solid #f3ede6; }
.select-ui { border: 1px solid var(--line); border-radius: 8px; padding: 6px; font-size: 14px; width: 96%; background: white; font-weight: bold; color: var(--main); }

/* æ˜Ÿæ˜Ÿé¡¯ç¤º */
.star-rating { display: flex; gap: 5px; }
.star {
  font-size: 32px; /* å¾ 26px æ”¾å¤§åˆ° 32pxï¼Œè®“ 3 é¡†æ˜Ÿåœ¨è¦–è¦ºä¸Šæ›´å¹³è¡¡ */
  cursor: pointer;
  color: #e0e0e0;
  transition: 0.2s;
}.star.active { color: var(--star); text-shadow: 0 0 5px rgba(255,202,40,0.5); }

/* ä¹å®®æ ¼ */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(62,39,35,0.85); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.numpad-container { background: white; padding: 30px; border-radius: 40px; width: 340px; }
.numpad-display { font-size: 50px; font-weight: 900; margin-bottom: 20px; background: #fbe9e7; padding: 15px; border-radius: 20px; text-align: center; color: var(--main); min-height: 70px; border: 3px solid #ffccbc; }
.numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }

.edit-chip { display: inline-block; background: #f3ede6; padding: 6px 10px; border-radius: 10px; margin: 2px; cursor: pointer; font-weight: 800; color: var(--main); border: 1px solid transparent; }
</style>
</head>
<body>

<div id="numPadModal" class="modal-overlay" onclick="closeNumPad()">
    <div class="numpad-container" onclick="event.stopPropagation()">
        <div id="numPadTitle" style="text-align:center; font-weight:bold; color:var(--main); margin-bottom:15px; font-size:20px;">è¼¸å…¥æ•¸å€¼</div>
        <div id="numPadDisplay" class="numpad-display">-</div>
        <div class="numpad-grid" id="numpadButtons"></div>
    </div>
</div>

<div class="container">
  <div class="header-full" style="text-align: center; padding: 10px 0;">
    <h1 style="color:var(--main); margin:0 0 20px 0; font-size:32px; letter-spacing: 1px;">ç²¾å“å’–å•¡ç´€éŒ„å™¨ v63.5</h1>
    <div style="display:flex; justify-content: center; gap:12px; flex-wrap: wrap;">
        <button onclick="location.href='https://christypy.github.io/'" style="background:var(--main); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-weight:bold; font-size:18px;">ğŸ  é¦–é </button>
        <button onclick="exportJSON()" style="background:var(--info); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-weight:bold; font-size:18px;">ğŸ“¥ åŒ¯å‡º</button>
        <button onclick="document.getElementById('fileInput').click()" style="background:var(--info); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-weight:bold; font-size:18px;">ğŸ“¤ åŒ¯å…¥</button>
        <input type="file" id="fileInput" style="display:none" onchange="importJSON(event)">
        <button onclick="clearAllHistory()" style="background:var(--danger); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-weight:bold; font-size:18px;">ğŸ”¥ æ¸…ç©º</button>
    </div>
  </div>

  <div>
    <div class="card" style="margin-bottom:25px;">
        <div class="section-title">æ²–ç…®åƒæ•¸</div>
        <div style="display:flex; gap:15px; margin-bottom:25px;">
            <button id="m-pour" class="tab-btn active pour" onclick="selectMode('pour')">æ‰‹æ²–æ¨¡å¼</button>
            <button id="m-esp" class="tab-btn" onclick="selectMode('espresso')">ç¾©å¼æ¨¡å¼</button>
        </div>
        <div id="beanBtns" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:25px;"></div>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px;">
            <div onclick="openNumPad('dose','ç²‰é‡ (10-60g)',true)">
                <span style="font-size:14px; font-weight:900; color:#a1887f; display:block; margin-bottom:8px;">ç²‰é‡(g)</span>
                <div id="d-dose" class="click-box">20</div>
            </div>
            <div onclick="openNumPad('grind','ç ”ç£¨ (1-10)',true)">
                <span style="font-size:14px; font-weight:900; color:#a1887f; display:block; margin-bottom:8px;">ç ”ç£¨åº¦</span>
                <div id="d-grind" class="click-box">6.0</div>
            </div>
            <div id="temp-row" onclick="openNumPad('temp','æ°´æº« (80-98Â°C)',false)">
                <span style="font-size:14px; font-weight:900; color:#a1887f; display:block; margin-bottom:8px;">æ°´æº«(Â°C)</span>
                <div id="d-temp" class="click-box">93</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="text-align: center; border-radius: 50%; margin: 15px auto; border: 12px solid #f3ede6; width: 220px; height: 220px; display: flex; flex-direction: column; justify-content: center; cursor: pointer; background: #fff;" onclick="handleTimerAction()">
            <div id="stepName" style="font-weight:900; color:var(--main); font-size:22px;">å¾…æ©Ÿä¸­</div>
            <div id="timer" style="font-size:58px; font-weight:900; font-family: monospace; color:#3e2723;">0:00</div>
            <div style="font-size:14px; color:#a1887f; margin-top:5px;">é»æ“Šåœ“åœˆç´€éŒ„</div>
        </div>
        <div style="display:grid; grid-template-columns: 3fr 1fr; gap:15px;">
            <button id="mainBtn" onclick="toggleTimer()" style="background:var(--main); color:white; border:none; height:75px; border-radius:20px; font-size:26px; font-weight:900;">START / STOP</button>
            <button onclick="resetTimer()" style="border:none; background:none; color:#a1887f; font-weight:900; font-size:18px;">RESET</button>
        </div>

        <div style="margin-top:30px; overflow-x:auto;">
            <table class="log-table">
                <thead id="logHead"></thead>
                <tbody id="logs"></tbody>
            </table>
            <button onclick="addManualRow()" style="width:100%; padding:15px; margin-top:15px; background:transparent; border:2px dashed var(--line); border-radius:15px; color:var(--primary); font-weight:900; font-size:18px;">â• æ‰‹å‹•æ–°å¢ç´€éŒ„</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; background:linear-gradient(135deg, #fbf9f7 0%, #efebe9 100%); padding:25px; border-radius:25px;">
            <div onclick="openNumPad('liquid','æœ€çµ‚ç¸½é‡',true)">
                <span style="font-size:16px; color:var(--primary); font-weight:900;">ç¸½é‡ (Liquid)</span>
                <div id="d-liquid" class="click-box" style="font-size:32px; border:none; padding:0; background:transparent; text-align:left;">0g</div>
            </div>
            <div style="text-align:right;">
                <span style="font-size:16px; color:var(--primary); font-weight:900;">ç²‰æ°´æ¯” (Ratio)</span>
                <div id="d-ratio" style="font-size:32px; font-weight:900; color:var(--main);">1:-</div>
            </div>
        </div>
        <div id="evalArea" style="display:flex; flex-direction:column; gap:15px; margin-top:25px;"></div>
        <button class="tab-btn" onclick="saveRecord()" style="background:var(--success); color:white; font-size:22px; margin-top:30px; width:100%; border-radius:20px; font-weight:900; padding:20px;">å„²å­˜æ­¤ç´€éŒ„æª”æ¡ˆ</button>
    </div>
  </div>

  <div>
    <div class="section-title">å…¨æ­·å²æ—¥èªŒæª”æ¡ˆ</div>
    <div style="display:flex; gap:15px; margin-bottom:25px;">
        <button id="tab-p" class="tab-btn active pour" onclick="switchHistoryTab('pour')">æ‰‹æ²–ç´€éŒ„é›†</button>
        <button id="tab-e" class="tab-btn" onclick="switchHistoryTab('espresso')">ç¾©å¼ç´€éŒ„é›†</button>
    </div>
    <div id="historyList"></div>
  </div>
</div>

<script>
let mode='pour', bean='è¦º', pours=[], isRunning=false, startTime=null, elapsed=0, timerInt=null, currentAction="æ³¨æ°´", wasStarted=false;
let params = { dose: 20, grind: 6.0, temp: 93, liquid: 0 };
let currentEval = {}, historyView = 'pour';
const baseBeans = ['è¦º','èŠ±','å¯¶','è©','é›…','éœ','æœ','ç¦','æŸ”','å®š','çœŸ','æ½¤'];

// --- æ¨¡å¼èˆ‡åˆå§‹åŒ– ---
function selectMode(m) {
    mode = m;
    if (m === 'espresso') { bean = 'æ··è±†'; params.dose = 20; params.grind = null; }
    else { bean = 'è¦º'; params.dose = 20; params.grind = 6.0; }
    document.getElementById('m-pour').className = 'tab-btn' + (m==='pour'?' active pour':'');
    document.getElementById('m-esp').className = 'tab-btn' + (m==='espresso'?' active esp':'');
    document.getElementById('temp-row').style.visibility = (m==='pour'?'visible':'hidden');
    buildBeans(); resetTimer();
}

function renderEvalArea(targetEval = currentEval, isHistory = false, logId = null) {
    const area = isHistory ? document.getElementById(`eval-hist-${logId}`) : document.getElementById('evalArea');
    if(!area) return; area.innerHTML = '';
    const fields = (isHistory ? (historyView === 'pour' ? ['é¦™æ°£','é…¸è³ª','é†‡åš','ç”œæ„Ÿ','é¤˜éŸ»'] : ['Crema','å¹³è¡¡','å£æ„Ÿ']) : (mode === 'pour' ? ['é¦™æ°£','é…¸è³ª','é†‡åš','ç”œæ„Ÿ','é¤˜éŸ»'] : ['Crema','å¹³è¡¡','å£æ„Ÿ']));
    
    fields.forEach(f => {
        const row = document.createElement('div'); 
        row.style = "display:flex; align-items:center; justify-content:space-between; padding:5px 0;";
        const score = targetEval[f] || 0;
        row.innerHTML = `<span style="font-weight:900; font-size:18px; color:var(--main);">${f}</span>
            <div class="star-rating">
                ${[1,2,3].map(s => `<span class="star ${s <= score ? 'active' : ''}" onclick="setEval('${f}',${s},this,${isHistory},${logId})">â˜…</span>`).join('')}
            </div>`;
        area.appendChild(row);
    });
}

function setEval(f, s, starEl, isHistory, logId) {
    event.stopPropagation();
    const stars = starEl.parentElement.children;
    for(let i=0; i<stars.length; i++) {
        stars[i].classList.toggle('active', i < s);
    }
    if (isHistory) {
        const key = historyView === 'pour' ? 'pourLogs' : 'espLogs';
        let logs = JSON.parse(localStorage.getItem(key));
        let log = logs.find(l => l.id === logId);
        log.eval[f] = s; localStorage.setItem(key, JSON.stringify(logs));
    } else { currentEval[f] = s; }
}

// --- æ ¸å¿ƒé‚è¼¯ (ç¹¼æ‰¿è‡ª v63.4 ä¸¦æ”¾å¤§å­—é«”) ---
function handleTimerAction() {
    if (!isRunning && !wasStarted) { toggleTimer(); return; }
    if (!isRunning) return;
    const nowSec = Math.round(elapsed/1000);
    if (mode === 'pour') {
        if (currentAction === "æ³¨æ°´") {
            pours.push({ name:"æ³¨æ°´", total:formatTime(elapsed), absSec:nowSec, cumLiquid:0, diffLiquid:0, path:"-", level:"-", flow:"-", isManual:false });
            currentAction = "æ–·æ°´";
            openNumPad('cumLiquid', 'è¼¸å…¥ç´¯ç©æ°´é‡', true, pours.length-1);
        } else {
            pours.push({ name:"æ–·æ°´", total:formatTime(elapsed), absSec:nowSec, cumLiquid:0, diffLiquid:0, path:"â—‹ ç¹åœˆ", level:"ä¸­æ°´ä½", flow:"ä¸­æ°´æµ", isManual:false });
            currentAction = "æ³¨æ°´";
        }
    } else {
        if (pours.length === 0) pours.push({ name:'é æµ¸', total:formatTime(elapsed), diff:nowSec+'s', absSec:nowSec });
        else if (pours.length === 1) { pours.push({ name:'èƒå–', total:formatTime(elapsed), diff:(nowSec-pours[0].absSec)+'s', absSec:nowSec }); toggleTimer(); }
    }
    updateUI();
}

function renderLogs() {
    const wrap = document.getElementById('logs'); wrap.innerHTML = '';
    const head = document.getElementById('logHead');
    if (mode === 'pour') {
        head.innerHTML = `<tr><th style="width:14%">å‹•ä½œ</th><th style="width:15%">æ™‚é–“</th><th style="width:18%">è·¯å¾‘</th><th style="width:14%">æ°´æµ</th><th style="width:14%">æ°´ä½</th><th style="width:13%">ç´¯ç©</th><th style="width:12%">å¢é‡</th></tr>`;
        pours.forEach((p, i) => {
            const tr = document.createElement('tr');
            const isWait = p.name === "æ–·æ°´";
            tr.innerHTML = `
                <td><b>${p.name}</b></td>
                <td><div class="edit-chip" onclick="openNumPad('absSec','æ™‚é–“',false,${i})">${p.total}</div></td>
                <td>${isWait ? `<select class="select-ui" onchange="pours[${i}].path=this.value"><option>â— ä¸­å¿ƒ</option><option selected>â—‹ ç¹åœˆ</option><option>âŠ™ æ··åˆ</option></select>` : '-'}</td>
                <td>${isWait ? `<select class="select-ui" onchange="pours[${i}].flow=this.value"><option>å¤§</option><option selected>ä¸­</option><option>å°</option></select>` : '-'}</td>
                <td>${isWait ? `<select class="select-ui" onchange="pours[${i}].level=this.value"><option>é«˜</option><option selected>ä¸­</option><option>ä½</option></select>` : '-'}</td>
                <td>${p.name==='æ³¨æ°´' ? `<div class="edit-chip" onclick="openNumPad('cumLiquid','æ°´é‡',true,${i})">${p.cumLiquid}</div>` : '-'}</td>
                <td style="color:var(--primary); font-weight:900;">${p.name==='æ³¨æ°´' ? `+${p.diffLiquid}` : '-'}</td>`;
            wrap.appendChild(tr);
        });
    } else {
        head.innerHTML = `<tr><th>éšæ®µ</th><th>è€—æ™‚</th><th>ç¸½æ™‚é–“</th></tr>`;
        pours.forEach((p, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><b>${p.name}</b></td><td><div class="edit-chip" onclick="openNumPad('absSec','ç§’æ•¸',false,${i})">${p.diff}</div></td><td>${p.total}</td>`;
            wrap.appendChild(tr);
        });
    }
}

// --- æ­·å²æ—¥èªŒæ¸²æŸ“ ---
function renderHistory() {
    const wrap = document.getElementById('historyList'); wrap.innerHTML = '';
    const key = historyView === 'pour' ? 'pourLogs' : 'espLogs';
    const logs = JSON.parse(localStorage.getItem(key) || '[]');
    logs.forEach(log => {
        const item = document.createElement('div');
        item.style = `background:white; border-radius:24px; padding:22px; margin-bottom:20px; border-left:10px solid ${historyView==='pour'?'var(--main)':'var(--esp-bg)'}; box-shadow:0 6px 20px rgba(0,0,0,0.06); cursor:pointer;`;
        item.onclick = () => { const el = document.getElementById(`details-${log.id}`); el.style.display = (el.style.display==='block'?'none':'block'); };
        item.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong style="font-size:20px; color:var(--main);">${log.bean}</strong> 
                <small style="font-weight:bold; color:#a1887f;">${log.time}</small>
            </div>
            <div style="margin-top:15px;">
                <span class="edit-chip" onclick="event.stopPropagation(); openNumPad('dose','ç²‰é‡',true,-1,${log.id})">${log.params.dose}g</span>
                <span class="edit-chip" onclick="event.stopPropagation(); openNumPad('grind','ç ”ç£¨',true,-1,${log.id})">ç ”ç£¨ ${log.params.grind || '--'}</span>
                <span class="edit-chip" onclick="event.stopPropagation(); openNumPad('liquid','ç¸½é‡',true,-1,${log.id})">ç¸½èƒ ${log.params.liquid}g</span>
                <span style="font-size:16px; font-weight:900; color:var(--primary); margin-left:10px;">1:${(log.params.liquid/log.params.dose).toFixed(1)}</span>
            </div>
            <div id="details-${log.id}" style="display:none; margin-top:20px; border-top:2px dashed #ece0d1; padding-top:15px;">
                <div id="eval-hist-${log.id}"></div>
                <table class="log-table" style="margin-top:15px;">
                    ${log.mode==='pour' ? log.details.map((d,idx) => `<tr>
                        <td><b>${d.name}</b></td>
                        <td><span class="edit-chip" onclick="openNumPad('absSec','æ™‚é–“',false,${idx},${log.id})">${d.total}</span></td>
                        <td>${d.path||'-'}</td>
                        <td>${d.flow||'-'}</td>
                        <td>${d.level||'-'}</td>
                        <td>${d.name==='æ³¨æ°´' ? `<span class="edit-chip" onclick="openNumPad('cumLiquid','æ°´é‡',true,${idx},${log.id})">${d.cumLiquid}g</span>` : '-'}</td>
                    </tr>`).join('') : log.details.map((d,idx) => `<tr><td><b>${d.name}</b></td><td>${d.diff}</td><td>${d.total}</td></tr>`).join('')}
                </table>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button class="tab-btn" style="background:var(--danger); color:white; padding:12px;" onclick="deleteRecord('${key}', ${log.id})">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</button>
                    <button class="tab-btn" style="background:var(--star); color:white; padding:12px;" onclick="toggleStar('${key}', ${log.id})">â­ æ”¶è—</button>
                </div>
            </div>`;
        wrap.appendChild(item);
        renderEvalArea(log.eval, true, log.id);
    });
}

// --- å…¶é¤˜å·¥å…·å‡½æ•¸ (ç¹¼æ‰¿è‡ª v63.4) ---
function updateUI() {
    const grindBox = document.getElementById('d-grind');
    if (params.grind === null) { grindBox.textContent = "--"; grindBox.classList.add('empty'); }
    else { grindBox.textContent = params.grind.toFixed(1); grindBox.classList.remove('empty'); }
    document.getElementById('d-dose').textContent = params.dose;
    document.getElementById('d-temp').textContent = params.temp;
    let lastCum = 0; pours.forEach(p => { if (p.name === "æ³¨æ°´") { p.diffLiquid = p.cumLiquid - lastCum; lastCum = p.cumLiquid; } });
    params.liquid = (mode==='pour') ? lastCum : params.liquid;
    document.getElementById('d-liquid').textContent = params.liquid + 'g';
    document.getElementById('d-ratio').textContent = `1:${params.liquid > 0 ? (params.liquid/params.dose).toFixed(1) : '-'}`;
    document.getElementById('stepName').textContent = (!wasStarted)?"å¾…æ©Ÿä¸­":(mode==='pour'?currentAction:(pours.length>=2?"çµæŸ":(pours.length===0?"é æµ¸":"èƒå–")));
    renderLogs();
}
function addManualRow() {
    if (mode === 'pour') pours.push({ name: (pours.length % 2 === 0 ? "æ³¨æ°´" : "æ–·æ°´"), total: "0:00", absSec: 0, cumLiquid: 0, diffLiquid: 0, path: "â—‹ ç¹åœˆ", level: "ä¸­æ°´ä½", flow:"ä¸­æ°´æµ", isManual: true });
    else { const name = pours.length === 0 ? "é æµ¸" : (pours.length === 1 ? "èƒå–" : "å®Œæˆ"); pours.push({ name: name, total: "0:00", diff: "0s", absSec: 0, isManual: true }); }
    updateUI();
}
function toggleTimer() {
    if (params.grind === null) { alert("è«‹å…ˆè¨­å®šç ”ç£¨åº¦ï¼"); openNumPad('grind','ç ”ç£¨ (1-10)',true); return; }
    if (!isRunning) { isRunning = true; wasStarted = true; startTime = Date.now() - elapsed; timerInt = setInterval(() => { elapsed = Date.now() - startTime; document.getElementById('timer').textContent = formatTime(elapsed); }, 100); }
    else { clearInterval(timerInt); isRunning = false; if (mode === 'espresso') openNumPad('liquid', 'è¼¸å…¥èƒå–é‡', true); else pours.push({ name:"å®Œæˆ", total:formatTime(elapsed), absSec:Math.round(elapsed/1000), cumLiquid:0 }); }
    updateUI();
}
function resetTimer() { clearInterval(timerInt); elapsed=0; isRunning=false; wasStarted=false; pours=[]; params.liquid=0; currentAction="æ³¨æ°´"; currentEval={}; document.getElementById('timer').textContent="0:00"; renderEvalArea(); updateUI(); }
function formatTime(ms) { const s=Math.floor(ms/1000); return `${Math.floor(s/60)}:${('0'+(s%60)).slice(-2)}`; }
function switchHistoryTab(tab) { historyView = tab; document.getElementById('tab-p').className = 'tab-btn' + (tab==='pour'?' active pour':''); document.getElementById('tab-e').className = 'tab-btn' + (tab==='espresso'?' active esp':''); renderHistory(); }
function buildBeans() {
    const wrap = document.getElementById('beanBtns'); wrap.innerHTML = '';
    (mode === 'espresso' ? [...baseBeans, 'æ··è±†'] : baseBeans).forEach(b => {
        const btn = document.createElement('button'); btn.textContent = b; btn.className = 'tab-btn' + (b===bean?' active pour':'');
        btn.style.padding = "12px"; btn.style.fontSize = "16px"; btn.onclick = () => { bean = b; buildBeans(); }; wrap.appendChild(btn);
    });
}
function saveRecord() {
    if(params.liquid <= 0 || params.grind === null) { alert("è«‹æª¢æŸ¥èƒå–é‡æˆ–ç ”ç£¨åº¦"); return; }
    const record = { id: Date.now(), mode, bean, params: {...params}, ratio: `1:${(params.liquid/params.dose).toFixed(1)}`, time: new Date().toLocaleString('zh-TW'), details: JSON.parse(JSON.stringify(pours)), eval: {...currentEval}, starred: false };
    const key = mode === 'pour' ? 'pourLogs' : 'espLogs';
    const logs = JSON.parse(localStorage.getItem(key) || '[]');
    logs.unshift(record); localStorage.setItem(key, JSON.stringify(logs));
    resetTimer(); switchHistoryTab(mode);
}

// --- ä¹å®®æ ¼ ---
let activeField = '', currentInputStr = '', tableIdx = -1, isFirstKey = true, editHistoryId = null;
function initNumpad() {
    const keys = ['1','2','3','4','5','6','7','8','9','.', '0', 'C'];
    document.getElementById('numpadButtons').innerHTML = keys.map(k => `<button class="tab-btn" onclick="pressKey('${k}')" style="height:70px; font-size:26px; background:#fff; border:1px solid #eee; border-radius:20px;">${k}</button>`).join('') 
                   + `<button class="tab-btn" onclick="confirmInput()" style="grid-column:span 3; background:var(--success); color:white; height:75px; font-size:24px;">ç¢ºèª OK</button>`;
}
function openNumPad(f, t, d, i = -1, hid = null) { activeField = f; tableIdx = i; editHistoryId = hid; isFirstKey = true; currentInputStr = ''; document.getElementById('numPadTitle').textContent = t; document.getElementById('numPadDisplay').textContent = "-"; document.getElementById('numPadModal').style.display = 'flex'; }
function pressKey(k) { if (k === 'C') { currentInputStr = ''; document.getElementById('numPadDisplay').textContent = "-"; isFirstKey = true; return; } if (isFirstKey) { currentInputStr = (k === '.') ? '0.' : k; isFirstKey = false; } else { if (k === '.' && currentInputStr.includes('.')) return; currentInputStr += k; } document.getElementById('numPadDisplay').textContent = currentInputStr; }
function closeNumPad() { document.getElementById('numPadModal').style.display = 'none'; }
function confirmInput() {
    let val = parseFloat(currentInputStr) || 0;
    if (activeField === 'dose' && (val < 10 || val > 60)) { alert("ç²‰é‡é™åˆ¶ 10-60g"); return; }
    if (activeField === 'grind' && (val < 1 || val > 10)) { alert("ç ”ç£¨é™åˆ¶ 1.0-10.0"); return; }
    if (mode === 'pour' && activeField === 'temp' && (val < 80 || val > 98)) { alert("æ°´æº«é™åˆ¶ 80-98Â°C"); return; }
    if (editHistoryId) { updateHistoryContent(editHistoryId, activeField, tableIdx, val); } 
    else { if (tableIdx === -1) { params[activeField] = val; } else { if (activeField === 'absSec') { pours[tableIdx].absSec = Math.round(val); pours[tableIdx].total = formatTime(pours[tableIdx].absSec * 1000); pours[tableIdx].diff = pours[tableIdx].absSec + 's'; } else if (activeField === 'cumLiquid') { pours[tableIdx].cumLiquid = val; } } }
    updateUI(); closeNumPad(); if(editHistoryId) renderHistory();
}
function updateHistoryContent(hid, field, idx, val) {
    const key = historyView === 'pour' ? 'pourLogs' : 'espLogs';
    let logs = JSON.parse(localStorage.getItem(key));
    let log = logs.find(l => l.id === hid);
    if (idx === -1) { log.params[field] = val; } else { if (field === 'absSec') { log.details[idx].absSec = Math.round(val); log.details[idx].total = formatTime(log.details[idx].absSec * 1000); log.details[idx].diff = log.details[idx].absSec + 's'; } else if (field === 'cumLiquid') { log.details[idx].cumLiquid = val; } }
    let last = 0; log.details.forEach(d => { if(d.name==="æ³¨æ°´"){ d.diffLiquid = d.cumLiquid - last; last = d.cumLiquid; } });
    log.params.liquid = (log.mode==='pour') ? last : log.params.liquid;
    log.ratio = `1:${(log.params.liquid / log.params.dose).toFixed(1)}`;
    localStorage.setItem(key, JSON.stringify(logs));
}
function deleteRecord(k, id) { event.stopPropagation(); if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) { let l = JSON.parse(localStorage.getItem(k)); l = l.filter(x => x.id !== id); localStorage.setItem(k, JSON.stringify(l)); renderHistory(); } }
function toggleStar(k, id) { event.stopPropagation(); let l = JSON.parse(localStorage.getItem(k)); let x = l.find(i => i.id === id); x.starred = !x.starred; localStorage.setItem(k, JSON.stringify(l)); renderHistory(); }
function exportJSON() { const d = { pour: JSON.parse(localStorage.getItem('pourLogs')||'[]'), esp: JSON.parse(localStorage.getItem('espLogs')||'[]') }; const b = new Blob([JSON.stringify(d)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'coffee_logs.json'; a.click(); }
function importJSON(e) { const r = new FileReader(); r.onload = (x) => { const d = JSON.parse(x.target.result); localStorage.setItem('pourLogs', JSON.stringify(d.pour)); localStorage.setItem('espLogs', JSON.stringify(d.esp)); renderHistory(); }; r.readAsText(e.target.files[0]); }
function clearAllHistory() { if(confirm("ç¢ºå®šæ¸…ç©ºå…¨éƒ¨æ­·å²ç´€éŒ„ï¼Ÿ")) { localStorage.clear(); renderHistory(); } }

window.onload = () => { initNumpad(); selectMode('pour'); switchHistoryTab('pour'); };
</script>
</body>
</html>