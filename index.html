<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸€å‘³æ·¨ç”Ÿæ´»å’–å•¡ç³»çµ± - é›²ç«¯ç‰ˆ</title>
<style>
    /* ä¿ç•™ä½ åŸæœ‰çš„æ‰€æœ‰ CSS æ¨£å¼ */
    :root {
        --color-primary: #5c3a21; --color-secondary: #9a6e4e; --color-accent: #e2b34a;
        --color-background: #fdf6e9; --color-light-gray: #e6e0d8; --color-done-bg: #f5f0e7;
        --color-success: #4a7d4a; --color-danger: #cf4a4a; --color-total-progress: #d68910;
        --color-section-bg: #ffffff; --color-text: #333333;
        --shadow-subtle: 0 1px 4px rgba(0,0,0,0.08); --shadow-medium: 0 3px 8px rgba(0,0,0,0.1);
        --border-radius-lg: 12px; --border-radius-md: 8px;
    }
    body { font-family: 'Noto Sans TC', sans-serif; background: var(--color-background); padding: 0 15px 30px 15px; color: var(--color-text); max-width: 960px; margin: 0 auto; line-height: 1.6; }
    h2 { text-align: center; color: var(--color-primary); margin: 20px 0 15px 0; font-size: 30px; font-weight: 700; }
    .info-section { background: var(--color-section-bg); padding: 15px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-medium); margin-bottom: 20px; border-left: 5px solid var(--color-secondary); }
    .info-section h3 { color: var(--color-primary); font-size: 18px; margin: 0 0 10px 0; border-bottom: 2px dashed var(--color-light-gray); padding-bottom: 8px; }
    .info-section ul { list-style: none; padding: 0; }
    .info-section li { font-size: 14px; padding: 4px 0; }
    #dynamicMemoList { display: flex; flex-wrap: wrap; gap: 15px; }
    .dynamic-memo-title { width: 100%; color: var(--color-danger); font-weight: bold; border-top: 2px dashed var(--color-danger); margin-top: 10px; }
    .controls { background: var(--color-section-bg); padding: 15px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-subtle); margin-bottom: 20px; display: flex; gap: 10px; }
    select { padding: 12px; border-radius: var(--border-radius-md); border: 1px solid var(--color-light-gray); flex-grow: 2; }
    .btn { background: var(--color-accent); color: var(--color-primary); border: none; padding: 12px 15px; border-radius: var(--border-radius-md); cursor: pointer; font-weight: bold; flex-grow: 1; }
    .stats-container { display: flex; gap: 20px; margin-bottom: 20px; }
    .stat-box { flex: 1; background: var(--color-section-bg); border-radius: var(--border-radius-lg); padding: 15px; box-shadow: var(--shadow-medium); border-top: 6px solid var(--color-primary); }
    .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; cursor: pointer; border-radius: 6px; }
    .stat-row-progress { height: 5px; background-color: var(--color-light-gray); border-radius: 2px; margin: 0 10px 8px 10px; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.3s ease; }
    .stat-detail-list { margin-top: 8px; border-top: 1px dashed var(--color-light-gray); }
    .stat-detail-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px dotted #e0e0e0; cursor: pointer; }
    .stat-detail-item.done { background-color: var(--color-done-bg); color: #888; text-decoration: line-through; }
    .customer-info { flex-grow: 1; }
    .customer-name { font-weight: 600; color: var(--color-primary); }
    .price-card-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
    .price-card { background: #fff; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-medium); overflow: hidden; border: 1px solid var(--color-light-gray); }
    .price-card-header { background: var(--color-primary); color: #fff; padding: 10px; text-align: center; font-weight: bold; }
    .price-grid { display: grid; grid-template-columns: 1fr 1fr; padding: 10px; }
    .price-item { padding: 8px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; font-size: 14px; }
    .menu-group-full { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
    .menu-group-full th { background: var(--color-secondary); color: #fff; padding: 10px; }
    .menu-group-full td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; font-weight: bold; }
    @media (max-width: 768px) { .price-card-container, .stats-container { grid-template-columns: 1fr; flex-direction: column; } }
</style>
</head>
<body>

<div id="loading" class="loading-overlay">åŒæ­¥ä¸­...</div>

<h2>â˜• ä¸€å‘³æ·¨ç”Ÿæ´»å’–å•¡å‚™é¤åŠ©ç† (é›²ç«¯)</h2>

<div class="controls">
    <select id="daySelect" onchange="renderOrders()">
        <option value="1">æ˜ŸæœŸä¸€ (ä¼‘)</option>
        <option value="2">æ˜ŸæœŸäºŒ</option>
        <option value="3">æ˜ŸæœŸä¸‰</option>
        <option value="4">æ˜ŸæœŸå››</option>
        <option value="5">æ˜ŸæœŸäº”</option>
        <option value="6">æ˜ŸæœŸå…­</option>
        <option value="0">æ˜ŸæœŸæ—¥</option>
    </select>
    <button class="btn" onclick="syncData()">æ‰‹å‹•åŒæ­¥</button>
    <button class="btn" id="clearAllBtn" onclick="clearAllDone()">å…¨éƒ¨é‡ç½®</button>
</div>

<div class="info-section">
    <h3>ğŸ“ å‚™å¿˜</h3>
    <ul id="staticMemoList">
        <li><b>æé¾å«©ä»™è‰ï¼š</b>ç’°ä¿æ¯ç†±ç¾å¼</li>
        <li><b>å…§è¡£åº—è€é—†ï¼š</b>ç†±æ‹¿éµ</li>
        <li><b>èŠ­æ¨‚ï¼š</b>ç†±æ‹¿éµ + ç³–(3g)</li>
    </ul>
    <ul id="dynamicMemoList"></ul>
</div>

<div class="stats-container">
    <div class="stat-box" style="border-top-color: var(--color-success);">
        <h3>ğŸ  å·¦å³é„°å±… ç¸½è¨ˆ</h3>
        <div id="stats-neighbor"></div>
    </div>
    <div class="stat-box" style="border-top-color: var(--color-total-progress);">
        <h3>ğŸ›µ å…¶ä»–å€åŸŸ ç¸½è¨ˆ</h3>
        <div id="stats-other"></div>
    </div>
</div>

<script>
    // --- é‡è¦ï¼šæ›¿æ›ç‚ºä½ çš„ API URL ---
    const API_URL = 'https://script.google.com/macros/s/AKfycbwa5pQ2bWvGcROvFXBNIWUnaYm16JdaRuf2xwY49NfJuqyY55W68yNuYoZlAPUlOOy8aQ/exec'; 

    let cloudData = {}; // å­˜å„²å¾é›²ç«¯æŠ“ä¸‹ä¾†çš„è³‡æ–™
    const expandedStats = new Set();
    const customers = [
        // ... (ä¿ç•™ä½ åŸæœ¬çš„ customers é™£åˆ—å…§å®¹) ...
    ];

    const typeNames = {
        hot_am: 'â˜• ç†±ç¾å¼', ice_am: 'ğŸ§Š å†°ç¾å¼', large_hot_am:"â˜•ï¸ å¤§ç†±ç¾",
        hot_latte: 'ğŸ”¥ ç†±æ‹¿éµ', hot_latte_sugar: 'ğŸ¬ ç†±æ‹¿éµ (åŠ ç³–)', 
        ice_latte_sugar: 'ğŸ­ å†°æ‹¿éµ (åŠ ç³–)', ice_latte: 'â„ï¸ å†°æ‹¿éµ', 
        large_hot_latte: 'ğŸ¥¤ å¤§ç†±æ‹¿', hand_drip: 'ğŸ’§ æ‰‹æ²–', potential_item: 'â“ å¾…ç¢ºèª'
    };

    // é¡¯ç¤ºè®€å–ä¸­
    function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

    // å¾ Google Sheets æŠ“å–è³‡æ–™
    async function syncData() {
        showLoading(true);
        try {
            const response = await fetch(API_URL);
            cloudData = await response.json();
            renderOrders();
        } catch (e) {
            alert('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®š');
        }
        showLoading(false);
    }

    // å¯«å…¥ Google Sheets
    async function updateCloud(key, value) {
        showLoading(true);
        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ key, value })
            });
            cloudData[key] = value;
            if (value === 'delete') delete cloudData[key];
            renderOrders();
        } catch (e) {
            alert('æ›´æ–°å¤±æ•—');
        }
        showLoading(false);
    }

    function getTodayDateString() {
        const today = new Date();
        return today.getFullYear() + (today.getMonth() + 1).toString().padStart(2, '0') + today.getDate().toString().padStart(2, '0');
    }

    function sanitizeKeyPart(s) { return s ? s.replace(/ /g, '_').replace(/[^a-zA-Z0-9\u4e00-\u9fa5_]/g, '') : ''; }
    function getStorageKey(name, item, loc, index = 0) { return `${getTodayDateString()}_${sanitizeKeyPart(name)}_${sanitizeKeyPart(item)}_${sanitizeKeyPart(loc)}_${index}`; }
    function getAbsenceKey(groupId) { return `${getTodayDateString()}_absent_${groupId}`; }
    function escapeJsString(s) { return s ? s.replace(/\\/g, '\\\\').replace(/'/g, '\\\'') : ''; }

    window.toggleDone = function(name, item, loc, index, groupId) {
        if (isGroupAbsent(groupId)) return;
        const key = getStorageKey(name, item, loc, index);
        const newValue = cloudData[key] === 'true' ? 'delete' : 'true';
        updateCloud(key, newValue);
    }

    window.toggleAbsence = function(groupId) {
        const key = getAbsenceKey(groupId);
        const newValue = cloudData[key] === 'true' ? 'delete' : 'true';
        updateCloud(key, newValue);
    }

    function isItemDone(name, item, loc, index = 0) { return cloudData[getStorageKey(name, item, loc, index)] === 'true'; }
    function isGroupAbsent(groupId) { return groupId ? cloudData[getAbsenceKey(groupId)] === 'true' : false; }
    
    window.clearAllDone = async function() {
        if (!confirm("ç¢ºå®šè¦é‡ç½®é›²ç«¯æ‰€æœ‰ç‹€æ…‹å—ï¼Ÿ")) return;
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ value: 'clearAll' }) });
        cloudData = {};
        renderOrders();
        showLoading(false);
    }

    // renderMemos èˆ‡ renderOrders é‚è¼¯åŸºæœ¬ç¶­æŒï¼Œä½†å°‡ localStorage æ”¹ç‚ºè®€å– cloudData
    function renderMemos(todaysOrders) {
        const memoList = document.getElementById('dynamicMemoList');
        const staticList = document.getElementById('staticMemoList');
        const dynamicMemos = todaysOrders.filter(c => c.tag && !c.tag.includes('å¯„æ¯') && !isGroupAbsent(c.groupId));
        const filterMemos = dynamicMemos.filter(c => {
             for (let i = 0; i < (c.count || 1); i++) if (!isItemDone(c.name, c.item, c.loc, i)) return true;
             return false;
        });
        if (filterMemos.length > 0) {
            let html = '<li class="dynamic-memo-title">ğŸ¯ ä»Šæ—¥éœ€ç¢ºèªï¼š</li>';
            filterMemos.forEach(c => html += `<li class="dynamic-memo-item"><b>${c.name.split('(')[0]}</b> <span class="memo-tag">${c.item}</span></li>`);
            memoList.innerHTML = html;
            staticList.classList.add('has-dynamic');
        } else {
            memoList.innerHTML = '';
            staticList.classList.remove('has-dynamic');
        }
    }

    function renderOrders() {
        const day = parseInt(document.getElementById('daySelect').value);
        const sNDiv = document.getElementById('stats-neighbor');
        const sODiv = document.getElementById('stats-other');
        
        if (day === 1) { 
            sNDiv.innerHTML = sODiv.innerHTML = '<div style="text-align:center;color:#999;padding:10px;">æœ¬æ—¥ä¼‘æ¯</div>';
            return; 
        }

        let sNeigh = {}, sOther = {};
        for (const k in typeNames) { sNeigh[k] = {total:0, done:0, orders:[]}; sOther[k] = {total:0, done:0, orders:[]}; }

        const todaysOrders = customers.filter(c => c.days.length === 0 || c.days.includes(day));
        renderMemos(todaysOrders);

        todaysOrders.forEach(c => {
            let target = (c.loc.includes("é„°å±…")) ? sNeigh : sOther;
            let isAbsent = isGroupAbsent(c.groupId);
            if (typeNames[c.type]) {
                if (!isAbsent) target[c.type].total += (c.count || 1);
                for(let i=0; i<(c.count||1); i++){
                    let done = isItemDone(c.name, c.item, c.loc, i);
                    if (done && !isAbsent) target[c.type].done++;
                    target[c.type].orders.push({...c, isDone: done, isAbsent, index: i});
                }
            }
        });

        const makeHtml = (stats, prefix) => {
            let html = '', totalN = 0, totalD = 0;
            for (const k in typeNames) {
                if (stats[k].total > 0) {
                    let s = stats[k], rem = s.total - s.done, per = Math.round((s.done/s.total)*100), id = `detail_${prefix}_${k}`;
                    html += `<div class="stat-row" onclick="toggleStatDetail('${id}')"><span>${typeNames[k]}</span><div class="progress-counts">å‰©: <b style="${rem===0?'color:var(--color-success)':''}">${rem}</b> / ${s.total}</div></div><div class="stat-row-progress"><div class="progress-fill" style="width:${per}%; background-color:${rem===0?'var(--color-success)':'var(--color-accent)'};"></div></div><div id="${id}" class="stat-detail-list" style="display:block;">${s.orders.map(o => {
                        let safe = [escapeJsString(o.name), escapeJsString(o.item), escapeJsString(o.loc), o.index, o.groupId];
                        return `<div class="stat-detail-item ${o.isAbsent?'absent':(o.isDone?'done':'')}"><span class="absence-toggle" onclick="event.stopPropagation(); toggleAbsence('${o.groupId}')">${o.isAbsent?'æ¢å¾©':'ç¼ºå¸­'}</span><div class="customer-info" onclick="toggleDone('${safe[0]}','${safe[1]}','${safe[2]}',${safe[3]},'${safe[4]}')"><span class="customer-name">${o.name}</span><br><small>${o.item}</small></div><input type="checkbox" ${o.isDone||o.isAbsent?'checked':''} disabled></div>`
                    }).join('')}</div>`;
                    totalN += s.total; totalD += s.done;
                }
            }
            return html || '<div style="text-align:center;color:#999;padding:10px;">ç„¡è¨‚å–®</div>';
        };
        sNDiv.innerHTML = makeHtml(sNeigh, 'n'); sODiv.innerHTML = makeHtml(sOther, 'o');
    }

    window.toggleStatDetail = function(id) {
        const el = document.getElementById(id);
        if (el) el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    document.getElementById('daySelect').value = new Date().getDay();
    syncData(); // åˆå§‹è¼‰å…¥é›²ç«¯è³‡æ–™
</script>
</body>
</html>