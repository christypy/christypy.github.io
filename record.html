<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç²¾å“å’–å•¡æ²–ç…®ç´€éŒ„å™¨ v27</title>
<style>
:root {
  --bg: #f8f9fa; --card: #ffffff; --main: #5d4037; --accent: #8d6e63;
  --text: #2c1e1c; --line: #e0e0e0; --primary: #795548; --danger: #d32f2f; --share: #388e3c;
}
body { margin: 0; font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
.container { max-width: 1200px; margin: auto; padding: 12px; display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 768px) { .container { grid-template-columns: 1fr 1fr; } .header-full { grid-column: span 2; } .history-section { grid-column: 2; grid-row: 2 / 10; } }

.home-link-btn {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 12px 24px; margin: 10px auto 20px;
  background-color: var(--main); color: white !important;
  text-decoration: none; border-radius: 50px;
  font-size: 16px; font-weight: bold;
  box-shadow: 0 4px 10px rgba(93, 64, 55, 0.2);
  transition: all 0.3s ease; width: fit-content;
}

.card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
.section-title { font-weight: 800; margin-bottom: 12px; font-size: 14px; color: var(--main); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; }
.section-title::before { content: ""; width: 4px; height: 14px; background: var(--main); margin-right: 8px; border-radius: 2px; }

.params-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #fdfaf9; padding: 12px; border-radius: 12px; }
.param-item { display: flex; flex-direction: column; gap: 4px; }
.param-label { font-size: 11px; color: #8d6e63; font-weight: bold; padding-left: 2px; }
.param-select { width: 100%; border: 1px solid var(--line); border-radius: 8px; padding: 6px; font-size: 13px; background: white; color: var(--main); outline: none; }

.bean-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 8px; }
.bean-btn { border: 1px solid var(--line); border-radius: 8px; padding: 8px 2px; background: white; cursor: pointer; font-size: 13px; color: #666; }
.bean-btn.active { background: var(--main); color: white; border-color: var(--main); }

.mode-switch { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; background: #efebe9; padding: 4px; border-radius: 10px; }
.mode-btn { border: none; border-radius: 8px; padding: 8px; cursor: pointer; font-weight: bold; background: transparent; color: #8d6e63; }
.mode-btn.active { background: white; color: var(--main); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

.timer-display { font-size: 48px; font-weight: 800; text-align: center; margin: 15px 0; color: var(--main); font-family: monospace; letter-spacing: -2px; }
.log-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; table-layout: fixed; }
.log-table th { background: #f5f5f5; padding: 8px 2px; border-bottom: 2px solid var(--line); }
.log-table td { padding: 6px 1px; text-align: center; border-bottom: 1px solid #f0f0f0; }
.log-table select { border: none; background: #f8f9fa; padding: 4px 2px; border-radius: 4px; font-size: 10px; width: 95%; }

.flavor-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; border-top: 1px solid var(--line); padding-top: 15px; }
.history-item { margin-bottom: 10px; border-radius: 12px; border: 1px solid var(--line); background: white; }

/* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
.btn-danger-outline {
  background: #fff5f5; color: var(--danger); border: 1px solid #ffcdd2;
  width: 100%; padding: 12px; border-radius: 10px; margin-top: 20px;
  font-weight: bold; font-size: 13px; cursor: pointer; transition: 0.2s;
}
.btn-danger-outline:active { background: #ffebee; transform: scale(0.98); }
</style>
</head>
<body>

<div class="container">
  <div class="header-full" style="text-align: center;">
    <h2 style="color:var(--main); margin:15px 0 5px;">ç²¾å“å’–å•¡æ²–ç…®ç´€éŒ„</h2>
    <a href="https://christypy.github.io/" class="home-link-btn">ğŸ  è¿”å›é¦–é </a>
  </div>

  <div class="card">
    <div class="section-title">æ¨¡å¼èˆ‡è±†ç¨®</div>
    <div class="mode-switch">
      <button id="mode-pour" class="mode-btn active" onclick="selectMode('pour',this)">æ‰‹æ²–ç´€éŒ„</button>
      <button id="mode-esp" class="mode-btn" onclick="selectMode('espresso',this)">ç¾©å¼èƒå–</button>
    </div>
    <div class="bean-grid" id="beanBtns"></div>
  </div>

  <div class="card">
    <div class="section-title">åˆå§‹åƒæ•¸</div>
    <div class="params-grid">
      <div class="param-item">
        <span class="param-label">ç²‰é‡</span>
        <select id="dose" class="param-select" onchange="calcStats()"></select>
      </div>
      <div class="param-item">
        <span class="param-label">ç ”ç£¨åº¦</span>
        <select id="grind" class="param-select"></select>
      </div>
      <div class="param-item" id="temp-row">
        <span class="param-label">æ°´æº«</span>
        <select id="temp" class="param-select"></select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="timer-display" id="timer">0:00</div>
    <div style="display:grid; grid-template-columns:2fr 1.2fr 1fr; gap:8px;">
      <button id="mainTimerBtn" onclick="handleTimerClick()" style="background:var(--main); color:white; border:none; font-weight:bold; font-size:16px; border-radius:12px; height:50px;">é–‹å§‹</button>
      <button onclick="logAction()" id="logBtn" style="border:2px solid var(--main); color:var(--main); font-weight:bold; border-radius:12px;">ç´€éŒ„</button>
      <button onclick="resetTimer()" style="color:#999; border:none; background:none;">é‡ç½®</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title">æ²–ç…®æ•¸æ“š</div>
    <div style="overflow-x: auto;">
      <table class="log-table">
        <thead id="logHead"></thead>
        <tbody id="logs"></tbody>
        <tfoot id="logFoot"></tfoot>
      </table>
    </div>
    <div class="flavor-box">
      <div><label class="param-label">æ¿ƒåº¦æ„Ÿ</label><select id="eval-strength" class="param-select"><option value="å‰›å¥½">å‰›å¥½</option><option value="å¤ªæ¿ƒ">å¤ªæ¿ƒ</option><option value="å¤ªæ·¡(æ°´æ„Ÿ)">å¤ªæ·¡(æ°´æ„Ÿ)</option></select></div>
      <div><label class="param-label">é…¸è‹¦å¹³è¡¡</label><select id="eval-balance" class="param-select"><option value="é…¸ç”œå¹³è¡¡">é…¸ç”œå¹³è¡¡</option><option value="å¤ªé…¸">å¤ªé…¸</option><option value="è‹¦æ¾€">è‹¦æ¾€</option></select></div>
    </div>
    <button onclick="saveRecord()" style="background:var(--main); color:white; width:100%; border:none; padding:15px; border-radius:12px; margin-top:15px; font-weight:bold; font-size:16px;">å„²å­˜æœ¬æ¬¡æ²–ç…®</button>
  </div>

  <div class="card history-section">
    <div class="section-title">æ­·å²æ—¥èªŒ</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
  <button onclick="exportBackup()" style="background:#607d8b; color:white; border:none; padding:10px; border-radius:10px; font-size:13px; font-weight:bold;">ğŸ’¾ å°å‡ºå‚™ä»½æª”</button>
  <button onclick="document.getElementById('importFile').click()" style="background:#78909c; color:white; border:none; padding:10px; border-radius:10px; font-size:13px; font-weight:bold;">ğŸ“¥ åŒ¯å…¥å‚™ä»½æª”</button>
  <input type="file" id="importFile" style="display:none" onchange="importBackup(this)">
</div>
    <button onclick="shareAllRecords()" style="background:var(--share); color:white; border:none; width:100%; padding:12px; border-radius:10px; margin-bottom:12px; font-weight:bold;">ğŸ“¤ åˆ†äº«å…¨éƒ¨ç´€éŒ„</button>
    <div id="pour-history-wrap"><div id="pour-history"></div></div>
    <div id="esp-history-wrap"><div id="esp-history"></div></div>
    
    <button class="btn-danger-outline" onclick="clearAllHistory()">ğŸ—‘ï¸ åˆªé™¤æ‰€æœ‰æ­·å²ç´€éŒ„</button>
  </div>
</div>

<script>
const baseBeans=['è¦º','èŠ±','å¯¶','è©','é›…','éœ','æœ','ç¦','æŸ”','å®š','çœŸ','æ½¤'];
let mode='pour', bean='è¦º', startTime=null, elapsed=0, timerInt=null, pours=[], isRunning=false, finalStats={ liquid: 0, ratio: '-', time: '0:00' };

window.onload = () => { initSelectors(); selectMode('pour', document.getElementById('mode-pour')); renderHistory(); };

function initSelectors() {
    const d = document.getElementById('dose');
    for(let i=12; i<=30; i+=0.5) { let o = new Option(i+'g', i); if(i===20) o.selected=true; d.add(o); }
    const g = document.getElementById('grind');
    for(let i=1; i<=15; i+=0.5) { let o = new Option(i, i); if(i===6) o.selected=true; g.add(o); }
    const t = document.getElementById('temp');
    for(let i=80; i<=99; i++) { let o = new Option(i+'Â°C', i); if(i===93) o.selected=true; t.add(o); }
}

function selectMode(m, btn) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('temp-row').style.visibility = (m === 'espresso') ? 'hidden' : 'visible';
    document.getElementById('logBtn').textContent = (m === 'espresso') ? 'é æµ¸çµæŸ' : 'ç´€éŒ„æ³¨æ°´';
    renderTableHead(); buildBeans(); resetTimer();
}

function renderTableHead() {
    const head = document.getElementById('logHead');
    head.innerHTML = (mode === 'pour') ? 
        `<tr><th width="14%">éšæ®µ</th><th width="14%">æ¯æ®µ</th><th width="14%">ç¸½æ™‚</th><th width="18%">è·¯å¾‘</th><th width="18%">æ°´ä½</th><th width="12%">ç´¯è¨ˆ</th><th width="10%">å¢</th></tr>` :
        `<tr><th>éšæ®µ</th><th>è€—æ™‚</th><th>ç¸½æ™‚é–“</th></tr>`;
}

function formatTime(ms) {
    const s = Math.floor(ms / 1000);
    return `${Math.floor(s/60)}:${('0'+(s%60)).slice(-2)}`;
}

function buildBeans() {
    const wrap = document.getElementById('beanBtns'); wrap.innerHTML = '';
    const list = (mode === 'espresso') ? [...baseBeans, 'æ··è±†'] : baseBeans;
    list.forEach(b => {
        const btn = document.createElement('button'); btn.textContent = b; btn.className = 'bean-btn';
        if (b === bean || (mode === 'espresso' && b === 'æ··è±†')) { btn.classList.add('active'); bean = b; }
        btn.onclick = () => { bean = b; wrap.querySelectorAll('.bean-btn').forEach(x => x.classList.remove('active')); btn.classList.add('active'); };
        wrap.appendChild(btn);
    });
}

function handleTimerClick() {
    const btn = document.getElementById('mainTimerBtn');
    if (!isRunning) {
        isRunning = true; btn.textContent = 'çµæŸæ²–ç…®'; btn.style.background = 'var(--danger)';
        startTime = Date.now() - elapsed;
        timerInt = setInterval(() => {
            elapsed = Date.now() - startTime;
            document.getElementById('timer').textContent = formatTime(elapsed);
        }, 100);
    } else {
        isRunning = false; btn.textContent = 'é–‹å§‹æ²–ç…®'; btn.style.background = 'var(--main)';
        clearInterval(timerInt); timerInt = null;
        finalizeBrew();
    }
}

function resetTimer() {
    clearInterval(timerInt); timerInt = null; elapsed = 0; isRunning = false;
    finalStats = { liquid: 0, ratio: '-', time: '0:00' };
    document.getElementById('timer').textContent = '0:00'; 
    pours = []; renderLogs();
    document.getElementById('logBtn').disabled = false;
    document.getElementById('mainTimerBtn').textContent = 'é–‹å§‹æ²–ç…®';
    document.getElementById('mainTimerBtn').style.background = 'var(--main)';
}

function logAction() {
    if (!isRunning) return;
    const currentTotalMs = elapsed;
    const totalStr = formatTime(currentTotalMs);
    if (mode === 'pour') {
        const lastAbsMs = pours.length > 0 ? pours[pours.length-1].absMs : 0;
        pours.push({ 
            name: pours.length === 0 ? 'æ‚¶è’¸' : `æ³¨æ°´ ${pours.length}`, 
            total: totalStr, absMs: currentTotalMs,
            diff: formatTime(currentTotalMs - lastAbsMs),
            path: 'å°åœˆ', waterLevel: 'ä½æ°´ä½',
            cumLiquid: (pours.length === 0 ? 40 : 0), diffLiquid: 0 
        });
        calcStats(); renderLogs();
    } else if (pours.length === 0) {
        pours.push({ name: 'é æµ¸', total: totalStr, diff: (elapsed/1000).toFixed(1)+'s', absSec: elapsed/1000 });
        document.getElementById('logBtn').textContent = 'èƒå–ä¸­...';
        document.getElementById('logBtn').disabled = true;
        renderLogs();
    }
}

// å°å‡ºå‚™ä»½
function exportBackup() {
    const data = {
        pourLogs: JSON.parse(localStorage.getItem('pourLogs') || '[]'),
        espLogs: JSON.parse(localStorage.getItem('espLogs') || '[]'),
        backupDate: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `coffee_backup_${new Date().toLocaleDateString()}.json`;
    a.click();
}

// åŒ¯å…¥å‚™ä»½
function importBackup(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (confirm("åŒ¯å…¥å°‡æœƒèˆ‡ç¾æœ‰ç´€éŒ„åˆä½µï¼Œç¢ºå®šå—ï¼Ÿ")) {
                const oldPour = JSON.parse(localStorage.getItem('pourLogs') || '[]');
                const oldEsp = JSON.parse(localStorage.getItem('espLogs') || '[]');
                
                // åˆä½µä¸¦å»é‡ï¼ˆç°¡å–®è™•ç†ï¼šåˆä½µå¾Œé‡æ–°æ¸²æŸ“ï¼‰
                localStorage.setItem('pourLogs', JSON.stringify([...data.pourLogs, ...oldPour]));
                localStorage.setItem('espLogs', JSON.stringify([...data.espLogs, ...oldEsp]));
                
                renderHistory();
                alert("åŒ¯å…¥æˆåŠŸï¼");
            }
        } catch (err) {
            alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿æ˜¯æ­£ç¢ºçš„å‚™ä»½æª”ã€‚");
        }
    };
    reader.readAsText(file);
}
function finalizeBrew() {
    const totalMs = elapsed;
    const totalStr = formatTime(totalMs);
    if (mode === 'pour') {
        if (pours.length > 0) {
            const lastIdx = pours.length - 1;
            pours[lastIdx].total = totalStr;
            pours[lastIdx].absMs = totalMs;
            const prevMs = (lastIdx === 0) ? 0 : pours[lastIdx-1].absMs;
            pours[lastIdx].diff = formatTime(totalMs - prevMs);
        }
    } else {
        const totalSec = totalMs / 1000;
        if (pours.length === 1) pours.push({ name: 'èƒå–', total: totalStr, diff: (totalSec - pours[0].absSec).toFixed(1)+'s' });
        else if (pours.length === 0) pours.push({ name: 'èƒå–(å…¨)', total: totalStr, diff: totalSec.toFixed(1)+'s' });
        if (finalStats.liquid === 0) updateEspLiquid(40);
    }
    finalStats.time = totalStr;
    calcStats(); renderLogs();
}

function updateDetail(idx, field, val) {
    pours[idx][field] = (field === 'cumLiquid') ? parseInt(val) : val;
    calcStats(); renderLogs();
}

function calcStats() {
    const dose = parseFloat(document.getElementById('dose').value);
    for (let i = 0; i < pours.length; i++) {
        const prevCum = (i === 0) ? 0 : pours[i-1].cumLiquid;
        pours[i].diffLiquid = pours[i].cumLiquid > 0 ? pours[i].cumLiquid - prevCum : 0;
    }
    if (pours.length > 0 && mode === 'pour') {
        const lastVal = pours[pours.length-1].cumLiquid;
        finalStats.liquid = lastVal;
        finalStats.ratio = lastVal > 0 ? `1:${(lastVal / dose).toFixed(1)}` : '-';
    }
}

function renderLogs() {
    const wrap = document.getElementById('logs'); wrap.innerHTML = '';
    const foot = document.getElementById('logFoot'); foot.innerHTML = '';
    pours.forEach((p, i) => {
        const tr = document.createElement('tr');
        if (mode === 'pour') {
            let pathOpt = `<select onchange="updateDetail(${i}, 'path', this.value)">` + ['ä¸­å¿ƒé»','å°åœˆ','å¤§åœˆ','ä¾†å›'].map(v=>`<option value="${v}" ${p.path===v?'selected':''}>${v}</option>`).join('') + `</select>`;
            let levelOpt = `<select onchange="updateDetail(${i}, 'waterLevel', this.value)">` + ['ä½æ°´ä½','ä¸­æ°´ä½','é«˜æ°´ä½'].map(v=>`<option value="${v}" ${p.waterLevel===v?'selected':''}>${v}</option>`).join('') + `</select>`;
            let cumOpt = `<select onchange="updateDetail(${i}, 'cumLiquid', this.value)"><option value="0">-</option>`;
            for(let j=20; j<=450; j+=5) { cumOpt += `<option value="${j}" ${p.cumLiquid==j?'selected':''}>${j}g</option>`; }
            cumOpt += `</select>`;
            tr.innerHTML=`<td>${p.name}</td><td>${p.diff}</td><td>${p.total}</td><td>${pathOpt}</td><td>${levelOpt}</td><td>${cumOpt}</td><td style="color:var(--primary); font-weight:bold;">${p.diffLiquid > 0 ? '+'+p.diffLiquid : '-'}</td>`;
        } else {
            tr.innerHTML=`<td>${p.name}</td><td>${p.diff||'-'}</td><td>${p.total||'-'}</td>`;
        }
        wrap.appendChild(tr);
    });
    if (mode === 'espresso' && (finalStats.time !== '0:00' || !isRunning)) {
        let sel = `<select onchange="updateEspLiquid(this.value)" class="param-select" style="width:70px;"><option value="0">æ¶²é‡</option>`;
        for(let i=15; i<=70; i++) sel += `<option value="${i}" ${finalStats.liquid==i?'selected':''}>${i}g</option>`;
        sel += `</select>`;
        foot.innerHTML = `<tr class="summary-row"><td colspan="2">æ¿ƒç¸®æ¶²é‡: ${sel}</td><td>æ¯”å€¼: ${finalStats.ratio}</td></tr>`;
    } else if (mode === 'pour') {
        foot.innerHTML = `<tr class="summary-row"><td colspan="4">ç¸½è¨ˆ: ${finalStats.liquid}g</td><td colspan="3">ç²‰æ°´æ¯”: ${finalStats.ratio}</td></tr>`;
    }
}

function updateEspLiquid(val) {
    finalStats.liquid = parseInt(val);
    const dose = parseFloat(document.getElementById('dose').value);
    finalStats.ratio = finalStats.liquid > 0 ? `1:${(finalStats.liquid / dose).toFixed(1)}` : '-';
    renderLogs();
}

function saveRecord() {
    if (pours.length === 0 || finalStats.liquid === 0) { alert("è«‹å¡«å¯«æ•¸æ“šä¸¦çµæŸè¨ˆæ™‚ï¼"); return; }
    const key = (mode === 'pour') ? 'pourLogs' : 'espLogs';
    const history = JSON.parse(localStorage.getItem(key) || '[]');
    history.unshift({
        time: new Date().toLocaleString('zh-TW',{hour12:false, month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}).replace(/\//g,'-'), 
        bean, dose: document.getElementById('dose').value, grind: document.getElementById('grind').value, 
        temp: (mode === 'pour') ? document.getElementById('temp').value : 'N/A',
        target: finalStats.liquid, pours: JSON.parse(JSON.stringify(pours)), mode, finalStats: {...finalStats},
        evaluation: { strength: document.getElementById('eval-strength').value, balance: document.getElementById('eval-balance').value }
    });
    localStorage.setItem(key, JSON.stringify(history));
    renderHistory(); resetTimer();
}

function formatSingleRecord(r) {
    let text = `â— ${r.bean} (${r.time})\n  ç²‰:${r.dose}g | ç ”ç£¨:${r.grind}${r.mode==='pour'?' | æ°´æº«:'+r.temp+'Â°C':''}\n  çµæœ:${r.target}g | æ¯”å€¼:${r.finalStats.ratio} | ç¸½æ™‚:${r.finalStats.time}\n  é¢¨å‘³ï¼š${r.evaluation.strength} / ${r.evaluation.balance}\n`;
    r.pours.forEach(p => text += (r.mode==='pour') ? `  â”” ${p.name}: ${p.diff} (ç¸½${p.total}) | ${p.cumLiquid}g [${p.path}/${p.waterLevel}]\n` : `  â”” ${p.name}: ${p.diff} (ç¸½${p.total})\n`);
    return text + `\n`;
}

async function shareRecord(key, index) {
    const list = JSON.parse(localStorage.getItem(key));
    const text = `ã€å’–å•¡ç´€éŒ„ã€‘\n` + formatSingleRecord(list[index]);
    if (navigator.share) { try { await navigator.share({ text: text }); } catch (err) {} }
    else { navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½ç´€éŒ„ï¼')); }
}

async function shareAllRecords() {
    const pLogs = JSON.parse(localStorage.getItem('pourLogs')||'[]');
    const eLogs = JSON.parse(localStorage.getItem('espLogs')||'[]');
    if(pLogs.length === 0 && eLogs.length === 0) { alert("ç›®å‰æ²’æœ‰ç´€éŒ„å¯åˆ†äº«"); return; }
    let fullText = `â˜•ã€å’–å•¡ç´€éŒ„å…¨å‚™ä»½ã€‘\n\n`;
    pLogs.forEach(r => fullText += formatSingleRecord(r));
    eLogs.forEach(r => fullText += formatSingleRecord(r));
    if (navigator.share) { try { await navigator.share({ text: fullText }); } catch (err) {} }
    else { navigator.clipboard.writeText(fullText).then(() => alert('å…¨éƒ¨ç´€éŒ„å·²è¤‡è£½ï¼')); }
}

function renderHistory() {
    ['pour-history','esp-history'].forEach(id => document.getElementById(id).innerHTML='');
    ['pourLogs','espLogs'].forEach(key => {
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        const wrap = document.getElementById(key === 'pourLogs' ? 'pour-history' : 'esp-history');
        if(list.length > 0) {
            wrap.innerHTML = `<div class="history-group-title" style="font-size:13px; font-weight:bold; margin:15px 0 8px; color:var(--primary);">${key==='pourLogs'?'ğŸ“‹ æ‰‹æ²–æ—¥èªŒ':'â˜• ç¾©å¼æ—¥èªŒ'}</div>`;
            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-header" onclick="toggleDetail(this)" style="padding:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                        <div style="font-size:12px;"><b>${item.bean}</b> <small style="color:#888;">${item.time}</small><br><span style="color:#666;">${item.finalStats.ratio} (${item.target}g) | ${item.evaluation.strength}</span></div>
                        <div><button onclick="shareRecord('${key}',${idx})" style="padding:4px 8px; font-size:11px; border:1px solid #ccc; background:none; border-radius:6px;">åˆ†äº«</button><button onclick="deleteItem('${key}',${idx},event)" style="margin-left:8px; color:#ccc; border:none; background:none;">âœ•</button></div>
                    </div>
                    <div class="history-detail" style="display:none; padding:10px; border-top:1px solid #eee; font-size:12px; background:#fafafa;">
                        <div>åƒæ•¸ï¼š${item.dose}g / ç ”ç£¨${item.grind}${item.mode==='pour'?' / '+item.temp+'Â°C':''}</div>
                        <div>è©•é‘‘ï¼š${item.evaluation.strength} / ${item.evaluation.balance}</div>
                        <table class="log-table" style="background:white;">
                            ${item.pours.map(p => item.mode==='pour' ? `<tr><td>${p.name}</td><td>${p.diff}</td><td>${p.total}</td><td>${p.path}</td><td>${p.waterLevel}</td><td>${p.cumLiquid}g</td></tr>` : `<tr><td>${p.name}</td><td>${p.diff}</td><td>${p.total}</td></tr>`).join('')}
                        </table>
                    </div>`;
                wrap.appendChild(div);
            });
        }
    });
}

function toggleDetail(el) { const d = el.nextElementSibling; d.style.display = (d.style.display === 'block') ? 'none' : 'block'; }
function deleteItem(k, i, e) { e.stopPropagation(); if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ")) { const h = JSON.parse(localStorage.getItem(k)); h.splice(i, 1); localStorage.setItem(k, JSON.stringify(h)); renderHistory(); } }

// æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰æ­·å²ç´€éŒ„å‡½å¼
function clearAllHistory() {
    if (confirm("âš ï¸ æ³¨æ„ï¼šé€™å°‡æœƒæ°¸ä¹…åˆªé™¤ã€Œæ‰€æœ‰æ‰‹æ²–èˆ‡ç¾©å¼ã€çš„æ­·å²ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) {
        localStorage.removeItem('pourLogs');
        localStorage.removeItem('espLogs');
        renderHistory();
        alert("å·²æ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„ã€‚");
    }
}
</script>
</body>
</html>