<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç²¾å“å’–å•¡ç´€éŒ„å™¨ v61 - ç¾åŒ–æ—¥èªŒç‰ˆ</title>
<style>
:root {
  --bg: #f8f9fa; --card: #ffffff; --main: #5d4037; --accent: #8d6e63;
  --text: #2c1e1c; --line: #e0e0e0; --primary: #795548; --danger: #ef5350;
  --wait-border: #ff9800; --pour-border: #00bcd4; --success: #66bb6a; --star: #ffc107; --info: #2196f3;
  --pour-theme: #795548; --esp-theme: #4e342e;
}
body { margin: 0; font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; font-size: 18px; }
.container { max-width: 1200px; margin: auto; padding: 20px; display: grid; grid-template-columns: 1fr; gap: 20px; }
@media (min-width: 768px) { .container { grid-template-columns: 1fr 1fr; } .header-full { grid-column: span 2; } .history-section { grid-column: 2; grid-row: 2 / 10; } }
.param-select { width: 100%; box-sizing: border-box; border: 2px solid var(--line); border-radius: 12px; padding: 10px 35px 10px 15px; font-size: 16px; background: #fff; cursor: pointer; color: var(--text); appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%238d6e63' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: border-color 0.2s; }
.param-select:focus { border-color: var(--accent); outline: none; }
.log-table .param-select { padding: 6px 25px 6px 8px; font-size: 15px; border-radius: 8px; border-width: 1px; }
.eval-group { display: flex; gap: 10px; margin-top: 10px; }
.eval-btn { flex: 1; border: 1px solid var(--line); background: #fff; padding: 12px; border-radius: 12px; font-size: 16px; font-weight: bold; color: #999; cursor: pointer; transition: all 0.2s; }
.eval-btn.active { color: white !important; }
.eval-btn.active[data-score="1"] { background: #ef5350; border-color: #ef5350; }
.eval-btn.active[data-score="2"] { background: #66bb6a; border-color: #66bb6a; }
.eval-btn.active[data-score="3"] { background: #ffc107; border-color: #ffc107; box-shadow: 0 4px 10px rgba(255,193,7,0.3); }
.home-link-btn { display: inline-flex; align-items: center; justify-content: center; padding: 14px 30px; margin: 10px auto 25px; background-color: var(--main); color: white !important; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 18px; }
.card { background: var(--card); border-radius: 24px; padding: 25px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.05); }
.section-title { font-weight: 800; margin-bottom: 20px; font-size: 20px; color: var(--main); display: flex; align-items: center; }
.section-title::before { content: ""; width: 6px; height: 22px; background: var(--main); margin-right: 12px; border-radius: 3px; }
.guide-area { text-align: center; border-radius: 24px; padding: 35px 15px; margin-bottom: 20px; border: 5px solid #eee; background: #fdfdfd; cursor: pointer; }
.timer-display { font-size: 80px; font-weight: 800; margin: 10px 0; font-family: 'Courier New', monospace; color: var(--main); }
.bean-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
.bean-btn { border: 1px solid var(--line); border-radius: 12px; padding: 14px 2px; background: white; cursor: pointer; font-size: 18px; color: #666; font-weight: bold; }
.bean-btn.active { background: var(--main); color: white; border-color: var(--main); }
.mode-switch { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; background: #efebe9; padding: 6px; border-radius: 16px; }
.mode-btn { border: none; border-radius: 12px; padding: 14px; cursor: pointer; font-weight: bold; font-size: 18px; background: transparent; color: #8d6e63; }
.mode-btn.active { background: white; color: var(--main); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.log-table { width: 100%; border-collapse: collapse; font-size: 15px; margin-top: 15px; }
.log-table th { background: #f5f5f5; padding: 12px 6px; border-bottom: 3px solid var(--line); text-align: center; color: var(--main); }
.log-table td { padding: 12px 6px; text-align: center; border-bottom: 1px solid #f0f0f0; }
.btn-add-step { background: #fff; color: var(--main); border: 2.5px dashed var(--main); width: 100%; padding: 18px; border-radius: 16px; margin-top: 15px; font-weight: bold; font-size: 17px; cursor: pointer; }
.toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 15px 30px; border-radius: 50px; z-index: 9999; display: none; font-size: 18px; }

/* æ­·å²æ—¥èªŒç¾åŒ–æ¨£å¼ */
.history-item { border-left: 8px solid var(--line); transition: all 0.2s; position: relative; }
.history-item.pour-mode { border-left-color: var(--pour-theme); }
.history-item.esp-mode { border-left-color: var(--esp-theme); }
.history-item.expanded { box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
.badge { display: inline-block; padding: 3px 10px; border-radius: 6px; background: #f0f0f0; color: #555; font-size: 13px; font-weight: bold; margin-right: 5px; margin-bottom: 5px; }
.badge-main { background: var(--main); color: white; }
.badge-ratio { background: #efebe9; color: var(--main); border: 1px solid #d7ccc8; }
.history-detail-table { width: 100%; font-size: 14px; margin-top: 12px; border-collapse: collapse; background: #fafafa; border-radius: 12px; overflow: hidden; }
.history-detail-table th { background: #eee; padding: 8px; font-size: 12px; color: #777; }
.history-detail-table td { padding: 8px; border-bottom: 1px solid #eee; }
.edit-badge { background: var(--info); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px; vertical-align: middle; }
</style>
</head>
<body>

<div id="toast" class="toast">âœ… ç´€éŒ„å·²å„²å­˜ï¼</div>

<div class="container">
  <div class="header-full" style="text-align: center;">
    <h2 style="color:var(--main); margin:20px 0 10px; font-size: 28px;">ç²¾å“å’–å•¡ç´€éŒ„å™¨ v61</h2>
    <a href="https://christypy.github.io/" class="home-link-btn">ğŸ  è¿”å›é¦–é </a>
  </div>

  <div class="card">
    <div class="section-title">æ¨¡å¼èˆ‡è±†ç¨® <span id="edit-indicator" style="display:none;" class="edit-badge">ç·¨è¼¯ä¸­</span></div>
    <div class="mode-switch">
      <button id="mode-pour" class="mode-btn active" onclick="selectMode('pour',this)">æ‰‹æ²–æ¨¡å¼</button>
      <button id="mode-esp" class="mode-btn" onclick="selectMode('espresso',this)">ç¾©å¼æ¨¡å¼</button>
    </div>
    <div id="beanBtns" class="bean-grid"></div>
  </div>

  <div class="card">
    <div class="section-title">æ²–ç…®åƒæ•¸</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
      <div><span style="font-size:14px; font-weight:bold; color:var(--accent); display:block; margin-bottom:5px;">ç²‰é‡</span><select id="dose" class="param-select" onchange="calcStats()"></select></div>
      <div><span style="font-size:14px; font-weight:bold; color:var(--accent); display:block; margin-bottom:5px;">ç ”ç£¨</span><select id="grind" class="param-select"></select></div>
      <div id="temp-row"><span style="font-size:14px; font-weight:bold; color:var(--accent); display:block; margin-bottom:5px;">æ°´æº«</span><select id="temp" class="param-select"></select></div>
    </div>
  </div>

  <div class="card">
    <div id="guideBox" class="guide-area" onclick="handleTimerAction()">
        <div id="stepName" style="font-weight:bold; color:var(--main); font-size:22px;">å¾…æ©Ÿä¸­</div>
        <div id="timer" class="timer-display">0:00</div>
    </div>
    <div style="display:grid; grid-template-columns: 3fr 1fr; gap:15px;">
        <button id="mainTimerBtn" onclick="toggleTimer()" style="background:var(--main); color:white; border:none; font-weight:bold; font-size:22px; border-radius:18px; height:70px;">é–‹å§‹</button>
        <button onclick="resetTimer()" style="color:#999; border:none; background:none; font-weight:bold; font-size:18px;">é‡ç½®</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title">éç¨‹ç´€éŒ„</div>
    <div style="overflow-x: auto;">
      <table class="log-table">
        <thead id="logHead"></thead>
        <tbody id="logs"></tbody>
      </table>
    </div>
    
    <div id="manual-tools">
        <button id="btn-pour-manual" class="btn-add-step" onclick="addManualPourCycle()">â• æ‰‹å‹•æ–°å¢æ³¨æ°´ç´€éŒ„</button>
        <button id="btn-esp-manual" class="btn-add-step" onclick="addManualEspCycle()" style="display:none;">â• æ‰‹å‹•æ–°å¢ç¾©å¼èƒå–</button>
    </div>

    <div style="background:#efebe9; padding:20px; border-radius:20px; margin-top:25px; display:grid; grid-template-columns: 1fr 1fr; text-align:center;">
        <div><div style="font-size:15px; color:var(--primary); font-weight:bold;">ç¸½é‡ (Liquid)</div><div id="stats-liquid-display" style="font-size:28px; font-weight:800;">0g</div></div>
        <div><div style="font-size:15px; color:var(--primary); font-weight:bold;">ç²‰æ°´æ¯” (Ratio)</div><div id="stats-ratio-display" style="font-size:28px; font-weight:800;">1:-</div></div>
    </div>

    <div class="section-title" style="margin-top:35px;">é¢¨å‘³è©•åƒ¹</div>
    <div id="evaluation-area"></div>

    <div id="save-buttons">
        <button id="btn-save" onclick="saveRecord()" style="background:var(--success); color:white; width:100%; border:none; padding:20px; border-radius:18px; margin-top:30px; font-weight:bold; font-size:22px;">å„²å­˜ç´€éŒ„</button>
        <button id="btn-update" onclick="updateRecord()" style="display:none; background:var(--info); color:white; width:100%; border:none; padding:20px; border-radius:18px; margin-top:30px; font-weight:bold; font-size:22px;">æ›´æ–°ç¾æœ‰ç´€éŒ„</button>
    </div>
  </div>

  <div class="card history-section">
    <div class="section-title">æ­·å²æ—¥èªŒ</div>
    <div id="pour-history"></div>
    <div id="esp-history"></div>
    <button onclick="clearAllHistory()" style="color:var(--danger); border:2px solid #ffcdd2; background:#fff5f5; width:100%; padding:15px; border-radius:15px; margin-top:25px; font-weight:bold; font-size:16px;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„</button>
  </div>
</div>

<script>
// --- æ ¸å¿ƒè®Šæ•¸ ---
const baseBeans = ['è¦º','èŠ±','å¯¶','è©','é›…','éœ','æœ','ç¦','æŸ”','å®š','çœŸ','æ½¤'];
const pourEvalData = [{ label: "é¦™æ°£", key: "aroma" }, { label: "é…¸è³ª", key: "acidity" }, { label: "é†‡åšåº¦", key: "body" }, { label: "ç”œæ„Ÿ", key: "sweet" }, { label: "é¤˜éŸ»", key: "finish" }];
const espEvalData = [{ label: "Crema", key: "crema" }, { label: "å¹³è¡¡æ„Ÿ", key: "taste" }, { label: "å£æ„Ÿ", key: "mouthfeel" }];

let mode='pour', bean='è¦º', startTime=null, elapsed=0, timerInt=null, pours=[], isRunning=false;
let currentAction = "æ³¨æ°´", finalStats = { liquid: 0, ratio: '-', time: '0:00' }, currentEval = {}, editingContext = null;

window.onload = () => { initSelectors(); selectMode('pour', document.getElementById('mode-pour')); renderHistory(); };

function initSelectors() {
    const d = document.getElementById('dose'); for(let i=12; i<=30; i+=0.5) { let o = new Option(i+'g', i); if(i===20) o.selected=true; d.add(o); }
    const g = document.getElementById('grind'); for(let i=1; i<=15; i+=0.5) { let o = new Option(i, i); if(i===6) o.selected=true; g.add(o); }
    const t = document.getElementById('temp'); for(let i=80; i<=99; i++) { let o = new Option(i+'Â°C', i); if(i===93) o.selected=true; t.add(o); }
}

function selectMode(m, btn) {
    mode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    document.getElementById('temp-row').style.visibility = (m === 'espresso') ? 'hidden' : 'visible';
    document.getElementById('btn-pour-manual').style.display = (m === 'pour') ? 'block' : 'none';
    document.getElementById('btn-esp-manual').style.display = (m === 'espresso') ? 'block' : 'none';
    if(!editingContext) bean = (m === 'espresso') ? 'æ··è±†' : 'è¦º';
    renderEvalArea(); resetTimer(); 
}

function renderEvalArea() {
    const area = document.getElementById('evaluation-area'); area.innerHTML = '';
    const fields = (mode === 'pour') ? pourEvalData : espEvalData;
    fields.forEach(f => {
        if(!editingContext) currentEval[f.key] = 0;
        const item = document.createElement('div'); item.style.marginBottom = "15px";
        item.innerHTML = `<span style="font-size:16px; font-weight:bold; color:var(--main);">${f.label}</span>
            <div class="eval-group" id="group-${f.key}">
                ${[1,2,3].map(s => `<button class="eval-btn" data-score="${s}" onclick="setEvalScore('${f.key}', ${s})">${s}</button>`).join('')}
            </div>`;
        area.appendChild(item);
    });
}

function setEvalScore(key, score) {
    currentEval[key] = score;
    document.querySelectorAll(`#group-${key} .eval-btn`).forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.score) === score));
}

// --- è¨ˆæ™‚èˆ‡ç´€éŒ„ ---
function toggleTimer() {
    if (!isRunning) {
        isRunning = true; startTime = Date.now() - elapsed;
        timerInt = setInterval(() => { elapsed = Date.now() - startTime; document.getElementById('timer').textContent = formatTime(elapsed); }, 100);
        document.getElementById('mainTimerBtn').textContent = "çµæŸ"; document.getElementById('mainTimerBtn').style.background = "var(--danger)";
        if (mode === 'espresso') pours = [];
        if (mode === 'pour' && pours.length === 0) { pours.push({ name: "æ³¨æ°´", total: "0:00", absMs: 0, path: 'å¤§åœˆ', flow: 'å°æ°´', cumLiquid: 0, diffLiquid: 0 }); currentAction = "æ–·æ°´"; }
        updateStatusText(); renderLogs();
    } else { finalizeBrew(); }
}

function handleTimerAction() {
    if (!isRunning) return;
    const nowMs = elapsed;
    if (mode === 'pour') {
        pours.push({ name: currentAction, total: formatTime(nowMs), absMs: nowMs, path: currentAction==='æ³¨æ°´'?'å¤§åœˆ':'-', flow: currentAction==='æ³¨æ°´'?'å°æ°´':'-', cumLiquid: 0, diffLiquid: 0 });
        currentAction = (currentAction === "æ³¨æ°´") ? "æ–·æ°´" : "æ³¨æ°´";
    } else if (mode === 'espresso' && pours.length === 0) {
        pours.push({ name: 'é æµ¸', total: formatTime(nowMs), diff: Math.round(nowMs/1000)+'s', absSec: Math.round(nowMs/1000) });
    }
    updateStatusText(); renderLogs();
}

function finalizeBrew() {
    clearInterval(timerInt); isRunning = false; finalStats.time = formatTime(elapsed);
    if (mode === 'espresso') {
        const totalSec = Math.round(elapsed / 1000);
        if (pours.length === 0) pours.push({ name: 'èƒå–', total: finalStats.time, diff: totalSec + 's', absSec: totalSec });
        else if (pours.length === 1) { const bSec = totalSec - pours[0].absSec; pours.push({ name: 'èƒå–', total: finalStats.time, diff: bSec + 's', absSec: bSec }); }
        if (finalStats.liquid === 0) finalStats.liquid = 60;
    }
    document.getElementById('mainTimerBtn').textContent = "ç¹¼çºŒ"; document.getElementById('mainTimerBtn').style.background = "var(--main)";
    updateStatusText(); calcStats(); renderLogs();
}

function addManualPourCycle() { pours.push({ name: "æ³¨æ°´", total: "1:00", absMs: 60000, path: 'å¤§åœˆ', flow: 'å°æ°´', cumLiquid: 0, diffLiquid: 0, isManual: true }, { name: "æ–·æ°´", total: "1:30", absMs: 90000, path: '-', flow: '-', cumLiquid: 0, diffLiquid: 0, isManual: true }); calcStats(); renderLogs(); }
function addManualEspCycle() { pours = [{ name: 'èƒå–', total: '0:30', diff: '30s', absSec: 30, isManual: true }]; finalStats.time = '0:30'; calcStats(); renderLogs(); }
function updateDetail(idx, field, val) { pours[idx][field] = (field === 'cumLiquid') ? parseInt(val) : val; calcStats(); renderLogs(); }
function updateEspTime(idx, val) { let sec = Math.round(parseFloat(val)); pours[idx].diff = sec + 's'; pours[idx].absSec = sec; let running = 0; pours.forEach(p => { running += p.absSec; p.total = formatTime(running * 1000); }); finalStats.time = (pours.length > 0) ? pours[pours.length-1].total : "0:00"; calcStats(); renderLogs(); }

function calcStats() {
    const d = parseFloat(document.getElementById('dose').value);
    if (mode === 'pour') {
        let last = 0; pours.forEach(p => { if (p.name === 'æ–·æ°´') { p.diffLiquid = p.cumLiquid > 0 ? (p.cumLiquid - last) : 0; last = p.cumLiquid > 0 ? p.cumLiquid : last; } else { p.diffLiquid = 0; } });
        const lp = [...pours].reverse().find(p => p.name === 'æ–·æ°´'); finalStats.liquid = lp ? lp.cumLiquid : 0;
    }
    finalStats.ratio = finalStats.liquid > 0 ? `1:${(finalStats.liquid / d).toFixed(1)}` : '-';
    const liqDisplay = document.getElementById('stats-liquid-display');
    if (mode === 'espresso') {
        let opt = `<select class="param-select" style="width:auto; font-size:24px; font-weight:800;" onchange="updateEspLiquid(this.value)">`;
        for(let i=10; i<=100; i++) opt += `<option value="${i}" ${finalStats.liquid==i?'selected':''}>${i}g</option>`;
        liqDisplay.innerHTML = opt + `</select>`;
    } else { liqDisplay.textContent = finalStats.liquid + 'g'; }
    document.getElementById('stats-ratio-display').textContent = finalStats.ratio;
}
function updateEspLiquid(val) { finalStats.liquid = parseInt(val); calcStats(); }

function renderLogs() {
    const wrap = document.getElementById('logs'); wrap.innerHTML = '';
    pours.forEach((p, i) => {
        const tr = document.createElement('tr');
        if (mode === 'pour') {
            let pathO = p.name==='æ–·æ°´'?'-':`<select class="param-select" onchange="updateDetail(${i},'path',this.value)">${['å¤§åœˆ','å°åœˆ','ä¸­å¿ƒ'].map(v=>`<option ${p.path===v?'selected':''}>${v}</option>`).join('')}</select>`;
            let flowO = p.name==='æ–·æ°´'?'-':`<select class="param-select" onchange="updateDetail(${i},'flow',this.value)">${['å°æ°´','å¤§æ°´'].map(v=>`<option ${p.flow===v?'selected':''}>${v}</option>`).join('')}</select>`;
            let cumO = p.name==='æ–·æ°´' ? `<select class="param-select" onchange="updateDetail(${i},'cumLiquid',this.value)"><option value="0">-</option>` + Array.from({length:381},(_,v)=>v+20).map(v=>`<option value="${v}" ${p.cumLiquid==v?'selected':''}>${v}g</option>`).join('') + `</select>` : '-';
            tr.innerHTML=`<td><b>${p.name}</b></td><td>${p.total}</td><td>${pathO}</td><td>${flowO}</td><td>${cumO}</td><td>${p.diffLiquid?'+'+p.diffLiquid:'-'}</td>`;
        } else {
            let dOpt = `<select class="param-select" onchange="updateEspTime(${i},this.value)">` + Array.from({length:121},(_,s)=>s).map(v=>`<option value="${v}" ${parseInt(p.diff)==v?'selected':''}>${v}s</option>`).join('') + `</select>`;
            tr.innerHTML=`<td>${p.name}</td><td>${isRunning ? p.diff : dOpt}</td><td>${p.total}</td>`;
        }
        wrap.appendChild(tr);
    });
}

// --- å­˜å„²èˆ‡æ¸²æŸ“æ­·å² ---
function packCurrentData() {
    return { mode, time: new Date().toLocaleString('zh-TW',{hour12:false, month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
        bean, dose: document.getElementById('dose').value, grind: document.getElementById('grind').value,
        temp: mode === 'pour' ? document.getElementById('temp').value : null, target: finalStats.liquid, ratio: finalStats.ratio,
        totalTime: finalStats.time, eval: JSON.parse(JSON.stringify(currentEval)), starred: false, details: JSON.parse(JSON.stringify(pours)) };
}
function saveRecord() {
    if (pours.length === 0 || (mode === 'pour' && finalStats.liquid === 0)) return alert("æ•¸æ“šä¸å®Œæ•´");
    const key = (mode === 'pour') ? 'pourLogs' : 'espLogs';
    const history = JSON.parse(localStorage.getItem(key) || '[]');
    history.unshift(packCurrentData()); localStorage.setItem(key, JSON.stringify(history));
    showToast(); renderHistory(); resetTimer();
}
function updateRecord() {
    if(!editingContext) return;
    const history = JSON.parse(localStorage.getItem(editingContext.key));
    const original = history[editingContext.idx];
    const updated = packCurrentData(); updated.time = original.time; updated.starred = original.starred;
    history[editingContext.idx] = updated; localStorage.setItem(editingContext.key, JSON.stringify(history));
    editingContext = null; showToast(); renderHistory(); resetTimer();
}
function editHistoryItem(key, idx) {
    const item = JSON.parse(localStorage.getItem(key))[idx];
    editingContext = { key, idx }; mode = item.mode; bean = item.bean;
    currentEval = JSON.parse(JSON.stringify(item.eval)); pours = JSON.parse(JSON.stringify(item.details));
    finalStats = { liquid: item.target, ratio: item.ratio, time: item.totalTime };
    document.getElementById('dose').value = item.dose; document.getElementById('grind').value = item.grind;
    if(item.temp) document.getElementById('temp').value = item.temp;
    document.getElementById('edit-indicator').style.display = 'inline';
    document.getElementById('btn-save').style.display = 'none'; document.getElementById('btn-update').style.display = 'block';
    selectMode(mode, null); renderLogs(); calcStats();
    Object.keys(currentEval).forEach(k => setEvalScore(k, currentEval[k]));
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderHistory() {
    ['pourLogs','espLogs'].forEach(key => {
        const wrap = document.getElementById(key==='pourLogs' ? 'pour-history' : 'esp-history'); wrap.innerHTML = '';
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        const fields = (key === 'pourLogs') ? pourEvalData : espEvalData;
        
        list.forEach((item, idx) => {
            const div = document.createElement('div'); 
            div.className = `card history-item ${item.mode}-mode`; 
            div.id = `hist-${key}-${idx}`;
            
            div.onclick = (e) => { if(!['BUTTON'].includes(e.target.tagName)) div.classList.toggle('expanded'); renderHistoryDetail(div, item, key, idx); };
            
            // è©•åˆ†é¡¯ç¤º (éæ¿¾ç¾©å¼/æ‰‹æ²–å°ˆå±¬)
            let evalLine = `<div style="display:flex; gap:5px; margin-top:8px; overflow-x:auto;">`;
            fields.forEach(f => {
                const s = item.eval[f.key] || 0;
                evalLine += `<span style="font-size:12px; background:#f0f0f0; padding:2px 8px; border-radius:4px; border:1px solid #ddd;">${f.label}:<b>${s}</b></span>`;
            });
            evalLine += `</div>`;
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1;">
                        <div style="margin-bottom:5px;"><b style="font-size:20px; color:var(--main);">${item.bean}</b> <small style="color:#999; margin-left:5px;">${item.time}</small></div>
                        <div style="display:flex; flex-wrap:wrap;">
                            <span class="badge badge-main">${item.target}g</span>
                            <span class="badge badge-ratio">${item.ratio}</span>
                            <span class="badge">${item.totalTime}</span>
                            <span class="badge">ç ”ç£¨ ${item.grind}</span>
                            ${item.temp? `<span class="badge">${item.temp}Â°C</span>`:''}
                        </div>
                        ${evalLine}
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                        <button onclick="event.stopPropagation(); toggleStar('${key}',${idx})" style="border:none; background:none; font-size:24px; color:${item.starred?'var(--star)':'#ddd'}; cursor:pointer;">â˜…</button>
                        <button onclick="event.stopPropagation(); deleteItem('${key}',${idx})" style="border:none; background:none; color:red; font-size:18px; cursor:pointer;">âœ•</button>
                    </div>
                </div>
                <div class="detail-content" style="display:none; margin-top:15px; border-top:1px dashed #ddd; padding-top:10px;"></div>
            `;
            wrap.appendChild(div);
        });
    });
}

function renderHistoryDetail(container, item, key, idx) {
    const detailArea = container.querySelector('.detail-content');
    if (container.classList.contains('expanded')) {
        detailArea.style.display = 'block';
        let tableHTML = `<table class="history-detail-table"><thead><tr><th>éšæ®µ</th><th>æ™‚é–“</th>${item.mode==='pour'?'<th>è·¯å¾‘</th><th>æ°´æµ</th><th>ç´¯è¨ˆ</th>':'<th>è€—æ™‚</th>'}</tr></thead><tbody>`;
        item.details.forEach(p => {
            tableHTML += `<tr><td>${p.name}</td><td>${p.total}</td>${item.mode==='pour'?`<td>${p.path||'-'}</td><td>${p.flow||'-'}</td><td>${p.cumLiquid?p.cumLiquid+'g':'-'}</td>`:`<td>${p.diff}</td>`}</tr>`;
        });
        tableHTML += `</tbody></table>`;
        tableHTML += `<button onclick="editHistoryItem('${key}',${idx})" style="width:100%; margin-top:12px; padding:12px; border-radius:12px; border:2px solid var(--info); background:white; color:var(--info); font-weight:bold; cursor:pointer;">âœï¸ ä¿®æ”¹æ­¤ç­†ç´€éŒ„</button>`;
        detailArea.innerHTML = tableHTML;
    } else {
        detailArea.style.display = 'none';
    }
}

// --- é€šç”¨å·¥å…· ---
function resetTimer() {
    clearInterval(timerInt); isRunning = false; elapsed = 0; currentAction = "æ³¨æ°´";
    if(!editingContext) {
        pours = []; if (mode === 'espresso') finalStats = { liquid: 60, ratio: '-', time: '0:00' }; else finalStats = { liquid: 0, ratio: '-', time: '0:00' };
        document.getElementById('edit-indicator').style.display = 'none';
        document.getElementById('btn-save').style.display = 'block'; document.getElementById('btn-update').style.display = 'none';
    }
    document.getElementById('timer').textContent = "0:00"; document.getElementById('mainTimerBtn').textContent = "é–‹å§‹";
    updateStatusText(); renderTableHead(); buildBeans(); renderLogs();
}
function formatTime(ms) { const s=Math.floor(ms/1000); return `${Math.floor(s/60)}:${('0'+(s%60)).slice(-2)}`; }
function showToast() { const t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
function updateStatusText() { const stepEl = document.getElementById('stepName'); stepEl.textContent = (!isRunning && elapsed === 0) ? "å¾…æ©Ÿä¸­" : (mode === 'pour' ? (currentAction === "æ³¨æ°´" ? "æ–·æ°´ä¸­" : "æ³¨æ°´ä¸­") : (isRunning ? "èƒå–ä¸­" : "çµæŸ")); }
function renderTableHead() { document.getElementById('logHead').innerHTML = (mode === 'pour') ? `<tr><th>å‹•ä½œ</th><th>ç¸½æ™‚</th><th>è·¯å¾‘</th><th>æ°´æµ</th><th>ç´¯ç©</th><th>å¢é‡</th></tr>` : `<tr><th>éšæ®µ</th><th>è€—æ™‚</th><th>ç¸½æ™‚é–“</th></tr>`; }
function buildBeans() { const wrap = document.getElementById('beanBtns'); wrap.innerHTML = ''; (mode === 'espresso' ? [...baseBeans, 'æ··è±†'] : baseBeans).forEach(b => { const btn = document.createElement('button'); btn.textContent = b; btn.className = 'bean-btn' + (b===bean?' active':''); btn.onclick = () => { bean = b; wrap.querySelectorAll('.bean-btn').forEach(x => x.classList.remove('active')); btn.classList.add('active'); }; wrap.appendChild(btn); }); }
function toggleStar(key, idx) { const h=JSON.parse(localStorage.getItem(key)); h[idx].starred=!h[idx].starred; localStorage.setItem(key,JSON.stringify(h)); renderHistory(); }
function deleteItem(k, i) { if(confirm("åˆªé™¤ï¼Ÿ")){ const h=JSON.parse(localStorage.getItem(k)); h.splice(i,1); localStorage.setItem(k,JSON.stringify(h)); renderHistory(); } }
function clearAllHistory() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")){ localStorage.clear(); renderHistory(); } }
</script>
</body>
</html>